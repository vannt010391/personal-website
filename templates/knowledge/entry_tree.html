{% load knowledge_tree %}

<ul class="entry-tree">
    {% for entry in entries %}
        {% set children = entry.children.all %}
        <li class="entry-tree-item" data-entry-id="{{ entry.id }}">
            <div class="entry-tree-node">
                {% if children %}
                    <button class="entry-tree-toggle" onclick="toggleEntry(this)" data-collapsed="false">
                        ▼
                    </button>
                {% else %}
                    <span class="entry-tree-toggle entry-tree-no-children"></span>
                {% endif %}
                <a href="{% url 'knowledge:entry_update' entry.slug %}"
                   class="entry-tree-link {% if current_slug == entry.slug %}active{% endif %}">
                    {{ entry.title|truncatewords:4 }}
                    {% if entry.is_favorite %}<span class="entry-tree-favorite">⭐</span>{% endif %}
                </a>
            </div>
            
            {% if children %}
            <ul class="entry-tree-children">
                {% for child in children %}
                    {% include "knowledge/entry_tree_item.html" with entry=child %}
                {% endfor %}
            </ul>
            {% endif %}
        </li>
    {% endfor %}
</ul>

<style>
    .entry-tree {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .entry-tree-item {
        margin: 0;
    }

    .entry-tree-node {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 4px;
        cursor: pointer;
    }

    .entry-tree-toggle {
        width: 20px;
        height: 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7b7268;
        transition: transform 0.2s;
    }

    .entry-tree-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .entry-tree-no-children {
        width: 20px;
        visibility: hidden;
    }

    .entry-tree-link {
        flex: 1;
        padding: 6px 8px;
        text-decoration: none;
        color: #7b7268;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 0.95rem;
    }

    .entry-tree-link:hover {
        background: #F9F8F6;
        color: #C9B59C;
    }

    .entry-tree-link.active {
        background: #D9CFC7;
        color: #3f372f;
        font-weight: 600;
    }

    .entry-tree-favorite {
        margin-left: 4px;
        font-size: 0.85rem;
    }

    .entry-tree-children {
        list-style: none;
        padding: 0;
        margin: 0;
        border-left: 2px solid #D9CFC7;
        margin-left: 10px;
        padding-left: 0;
    }

    .entry-tree-children.collapsed {
        display: none;
    }
</style>

<script>
function toggleEntry(button) {
    const li = button.closest('.entry-tree-item');
    const children = li.querySelector('.entry-tree-children');
    
    if (!children) return;
    
    const isCollapsed = button.dataset.collapsed === 'true';
    button.dataset.collapsed = !isCollapsed;
    button.classList.toggle('collapsed');
    children.classList.toggle('collapsed');
}
</script>
