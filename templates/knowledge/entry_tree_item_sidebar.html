{% load static %}

<div class="sidebar-tree-item" style="margin-bottom: 2px;">
    <div class="sidebar-tree-node" style="display: flex; align-items: center; gap: 4px;">
        {% with children=entry.children.all %}
        {% if children %}
            <button class="sidebar-tree-toggle collapsed" onclick="toggleSidebarEntry(this)" data-collapsed="true"
                    style="width: 16px; height: 16px; border: none; background: none; cursor: pointer; font-size: 10px; padding: 0; color: #7b7268; transition: transform 0.2s;"
                    title="Click to expand">
                ‚ñº
            </button>
        {% else %}
            <span style="width: 16px; display: inline-block;"></span>
        {% endif %}
        {% endwith %}

        <a href="{% url 'knowledge:entry_detail' entry.slug %}"
           class="sidebar-tree-link"
           style="flex: 1; padding: 6px 8px; text-decoration: none; color: #7b7268; border-radius: 4px; transition: all 0.2s; font-size: 0.9rem; display: block;">
            <span style="margin-right: 6px;">üìÑ</span>
            {{ entry.title|truncatewords:5 }}
            {% if entry.is_favorite %}<span style="margin-left: 4px; font-size: 0.85rem;">‚≠ê</span>{% endif %}
            {% with children=entry.children.all %}
            {% if children %}
                <span style="margin-left: 6px; font-size: 0.75rem; color: #C9B59C; opacity: 0.8;">({{ children|length }})</span>
            {% endif %}
            {% endwith %}
        </a>
    </div>

    {% with children=entry.children.all %}
    {% if children %}
    <div class="sidebar-tree-children collapsed" style="margin-left: 20px; border-left: 2px solid #D9CFC7; padding-left: 5px;">
        {% for child in children %}
            {% include "knowledge/entry_tree_item_sidebar.html" with entry=child %}
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
</div>

<style>
    .sidebar-tree-link:hover {
        background: #EFE9E3;
        color: #C9B59C;
    }

    .sidebar-tree-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .sidebar-tree-children.collapsed {
        display: none;
    }
</style>

<script>
function toggleSidebarEntry(button) {
    const item = button.closest('.sidebar-tree-item');
    const children = item.querySelector('.sidebar-tree-children');

    if (!children) return;

    const isCollapsed = button.dataset.collapsed === 'true';
    button.dataset.collapsed = !isCollapsed;
    button.classList.toggle('collapsed');
    children.classList.toggle('collapsed');
}
</script>
