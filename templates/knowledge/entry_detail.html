{% extends 'base.html' %}
{% load static %}
{% load knowledge_extras %}

{% block title %}{{ entry.title }} - Kiáº¿n Thá»©c{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
<link rel="stylesheet" href="{% static 'css/code-highlight.css' %}">
{% endblock %}

{% block content %}
<div class="gitbook-container">
    <!-- Left Sidebar with Page Structure -->
    <aside class="gitbook-sidebar">
        <div style="margin-bottom: 20px;">
            <a href="{% url 'knowledge:entry_list' %}"
               style="display: block; padding: 10px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                â† Danh sÃ¡ch táº¥t cáº£
            </a>
        </div>

        {% if entry.topic %}
        <div style="margin-bottom: 20px; padding: 12px; background: #EFE9E3; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 4px;">ğŸ“š Chá»§ Ä‘á»:</div>
            <div style="font-weight: 600; color: #3f372f;">{{ entry.topic.name }}</div>
        </div>
        {% endif %}

        <h3>ğŸ“„ Cáº¥u trÃºc trang</h3>

        <!-- Search Box for Filtering -->
        <div style="margin-bottom: 15px;">
            <input type="text" id="page-search" placeholder="ğŸ” TÃ¬m kiáº¿m trang..."
                   style="width: 100%; padding: 10px 12px; border: 1px solid #D9CFC7; border-radius: 6px; font-size: 0.9rem; color: #3f372f; background: white; transition: all 0.2s;"
                   onkeyup="filterPages(this.value)"
                   onfocus="this.style.borderColor='#C9B59C'; this.style.boxShadow='0 0 0 3px rgba(201, 181, 156, 0.1)';"
                   onblur="this.style.borderColor='#D9CFC7'; this.style.boxShadow='none';">
        </div>

        <div class="entry-tree-container">
            <!-- Parent Page -->
            {% if entry.parent %}
                <div class="page-item" style="margin-bottom: 10px;">
                    <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}"
                       class="gitbook-sidebar-item"
                       style="font-size: 0.9rem; opacity: 0.8;"
                       data-page-title="{{ entry.parent.title|lower }}">
                        â¬†ï¸ {{ entry.parent.title|truncatewords:5 }}
                    </a>
                </div>
            {% endif %}

            <!-- Current Page (Highlighted) -->
            <div class="page-item current-page" style="margin: 10px 0; padding: 12px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.15) 0%, rgba(217, 207, 199, 0.15) 100%); border-left: 3px solid #C9B59C; border-radius: 6px;">
                <div style="font-weight: 600; color: #3f372f; margin-bottom: 8px;">
                    ğŸ“„ {{ entry.title }}{% if entry.is_favorite %} â­{% endif %}
                </div>
                <a href="{% url 'knowledge:entry_create' %}?parent={{ entry.id }}"
                   style="display: inline-block; padding: 6px 12px; background: #C9B59C; color: white; border-radius: 4px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;"
                   onmouseover="this.style.background='#B8A58B';"
                   onmouseout="this.style.background='#C9B59C';">
                    â• ThÃªm trang con
                </a>
            </div>

            <!-- Child Pages -->
            {% if entry.children.all %}
                <div class="children-section" style="margin-left: 15px; border-left: 2px solid #D9CFC7; padding-left: 10px;">
                    <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 8px; font-weight: 600;">
                        Trang con: <span class="children-count">({{ entry.children.all|length }})</span>
                    </div>
                    <div class="children-list">
                        {% for child in entry.children.all %}
                            <a href="{% url 'knowledge:entry_detail' child.slug %}"
                               class="page-item gitbook-sidebar-item {% if forloop.counter > 10 %}hidden-item{% endif %}"
                               style="margin-bottom: 4px; {% if forloop.counter > 10 %}display: none;{% endif %}"
                               data-page-title="{{ child.title|lower }}">
                                ğŸ“„ {{ child.title|truncatewords:5 }}
                                {% if child.is_favorite %} â­{% endif %}
                            </a>
                        {% endfor %}
                    </div>
                    {% if entry.children.all|length > 10 %}
                    <button onclick="showMoreChildren(this)"
                            style="margin-top: 8px; padding: 6px 10px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#D9CFC7';"
                            onmouseout="this.style.background='#EFE9E3';">
                        â• Hiá»‡n thÃªm {{ entry.children.all|length|add:"-10" }} trang
                    </button>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Sibling Pages -->
            {% if sibling_pages %}
                <div class="siblings-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #D9CFC7;">
                    <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 8px; font-weight: 600;">
                        {% if entry.parent %}Trang cÃ¹ng cáº¥p:{% else %}Trang khÃ¡c trong chá»§ Ä‘á»:{% endif %}
                        <span class="siblings-count">({{ sibling_pages|length }})</span>
                    </div>
                    <div class="siblings-list">
                        {% for page in sibling_pages %}
                            <a href="{% url 'knowledge:entry_detail' page.slug %}"
                               class="page-item gitbook-sidebar-item {% if forloop.counter > 10 %}hidden-item{% endif %}"
                               style="margin-bottom: 4px; opacity: 0.8; {% if forloop.counter > 10 %}display: none;{% endif %}"
                               data-page-title="{{ page.title|lower }}">
                                ğŸ“„ {{ page.title|truncatewords:5 }}
                                {% if page.is_favorite %} â­{% endif %}
                            </a>
                        {% endfor %}
                    </div>
                    {% if sibling_pages|length > 10 %}
                    <button onclick="showMoreSiblings(this)"
                            style="margin-top: 8px; padding: 6px 10px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#D9CFC7';"
                            onmouseout="this.style.background='#EFE9E3';">
                        â• Hiá»‡n thÃªm {{ sibling_pages|length|add:"-10" }} trang
                    </button>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <h3 style="margin-top: 25px;">âš™ï¸ Quáº£n lÃ½</h3>
        <a href="{% url 'knowledge:search' %}" class="gitbook-sidebar-item">ğŸ” TÃ¬m kiáº¿m</a>
        <a href="{% url 'knowledge:topic_list' %}" class="gitbook-sidebar-item">ğŸ“Œ Chá»§ Ä‘á»</a>
        <a href="{% url 'knowledge:resource_list' %}" class="gitbook-sidebar-item">ğŸ“– TÃ i liá»‡u</a>

        <h3 style="margin-top: 20px;">âœï¸ Trang nÃ y</h3>
        <a href="{% url 'knowledge:entry_update' entry.slug %}" class="gitbook-sidebar-item">âœï¸ Chá»‰nh sá»­a</a>
        <a href="{% url 'knowledge:entry_delete' entry.slug %}" class="gitbook-sidebar-item" onclick="return confirm('Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a?')">ğŸ—‘ï¸ XÃ³a</a>
    </aside>

    <!-- Main Content -->
    <main class="gitbook-main" style="max-width: 900px; margin: 0 auto; padding: 40px 60px;">
        <!-- Breadcrumb - Minimal -->
        <div style="margin-bottom: 30px; font-size: 0.85rem; color: #7b7268;">
            <a href="{% url 'knowledge:entry_list' %}" style="color: #7b7268; text-decoration: none; transition: color 0.2s;">Kiáº¿n Thá»©c</a>
            {% if entry.topic %} <span style="color: #D9CFC7;">â€º</span> <a href="?topic={{ entry.topic.id }}" style="color: #7b7268; text-decoration: none;">{{ entry.topic.name }}</a>{% endif %}
            {% if entry.parent %} <span style="color: #D9CFC7;">â€º</span> <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}" style="color: #7b7268; text-decoration: none;">{{ entry.parent.title|truncatewords:5 }}</a>{% endif %}
        </div>

        <!-- Title - Large and Clean -->
        <h1 style="font-size: 3rem; font-weight: 700; margin: 0 0 15px 0; color: #3f372f; line-height: 1.2;">
            {{ entry.title }}{% if entry.is_favorite %} <span style="color: #C9B59C;">â­</span>{% endif %}
        </h1>

        <!-- Summary - Minimal if present -->
        {% if entry.summary %}
        <p style="font-size: 1.1rem; color: #7b7268; margin: 0 0 30px 0; line-height: 1.6;">
            {{ entry.summary }}
        </p>
        {% endif %}

        <!-- Meta Info - Very minimal -->
        <div style="display: flex; gap: 15px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #EFE9E3; font-size: 0.85rem; color: #7b7268;">
            {% if entry.entry_type %}
            <span>{{ entry.get_entry_type_display }}</span>
            {% endif %}
            <span>â€¢</span>
            <span>{{ entry.updated_at|date:"d/m/Y" }}</span>
            {% if entry.tags %}
            <span>â€¢</span>
            <span>
                {% for tag in entry.tags|split:"," %}
                    #{{ tag|trim }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </span>
            {% endif %}
        </div>

        <!-- Children Pages as Cards (if this is a parent page) -->
        {% if entry.children.all %}
        <div style="margin-bottom: 50px;">
            <p style="color: #7b7268; font-size: 0.95rem; margin-bottom: 20px;">CÃ¡c trang trong pháº§n nÃ y:</p>
            <div style="display: grid; gap: 15px;">
                {% for child in entry.children.all %}
                <a href="{% url 'knowledge:entry_detail' child.slug %}"
                   style="display: flex; align-items: center; gap: 15px; padding: 20px; background: white; border: 1px solid #EFE9E3; border-radius: 8px; text-decoration: none; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#C9B59C'; this.style.transform='translateX(5px)';"
                   onmouseout="this.style.borderColor='#EFE9E3'; this.style.transform='translateX(0)';">
                    <div style="font-size: 1.5rem;">ğŸ“„</div>
                    <div>
                        <div style="font-weight: 600; color: #3f372f; margin-bottom: 4px;">{{ child.title }}</div>
                        {% if child.summary %}
                        <div style="font-size: 0.9rem; color: #7b7268;">{{ child.summary|truncatewords:15 }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Main Article Content -->
        <article class="gitbook-content" style="margin-bottom: 50px;">
            {{ content_html|safe }}
        </article>

        <!-- Source URL - Minimal -->
        {% if entry.source_url %}
        <div style="margin: 40px 0; padding: 15px 20px; background: #F9F8F6; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 6px;">ğŸ“š Nguá»“n tham kháº£o</div>
            <a href="{{ entry.source_url }}" target="_blank" style="color: #C9B59C; text-decoration: none; word-break: break-all; font-size: 0.9rem;">
                {{ entry.source_url }}
            </a>
        </div>
        {% endif %}

        <!-- Edit Button - Floating at bottom -->
        <div style="margin-top: 60px; padding-top: 30px; border-top: 1px solid #EFE9E3;">
            <a href="{% url 'knowledge:entry_update' entry.slug %}"
               style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #F9F8F6; color: #7b7268; border: 1px solid #D9CFC7; border-radius: 6px; text-decoration: none; font-size: 0.9rem; transition: all 0.2s;"
               onmouseover="this.style.background='#EFE9E3';"
               onmouseout="this.style.background='#F9F8F6';">
                âœï¸ Chá»‰nh sá»­a trang nÃ y
            </a>
        </div>
    </main>
</div>

<style>
    .gitbook-content {
        line-height: 1.8;
        color: #3f372f;
    }

    .gitbook-content h1 {
        font-size: 2rem;
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #D9CFC7;
    }

    .gitbook-content h2 {
        font-size: 1.6rem;
        margin: 35px 0 15px 0;
        color: #3f372f;
    }

    .gitbook-content h3 {
        font-size: 1.3rem;
        margin: 25px 0 12px 0;
        color: #3f372f;
    }

    .gitbook-content h4, .gitbook-content h5, .gitbook-content h6 {
        margin: 20px 0 10px 0;
        color: #3f372f;
    }

    .gitbook-content p {
        margin: 15px 0;
    }

    .gitbook-content ul, .gitbook-content ol {
        margin: 15px 0;
        padding-left: 30px;
    }

    .gitbook-content li {
        margin: 8px 0;
    }

    .gitbook-content code {
        background: #F9F8F6;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #C9B59C;
    }

    .gitbook-content pre {
        background: #3f372f;
        color: #F9F8F6;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 20px 0;
    }

    .gitbook-content pre code {
        background: none;
        padding: 0;
        color: #F9F8F6;
    }

    .gitbook-content blockquote {
        border-left: 4px solid #C9B59C;
        padding-left: 20px;
        margin: 20px 0;
        color: #7b7268;
        font-style: italic;
    }

    .gitbook-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .gitbook-content table th {
        background: #D9CFC7;
        color: #3f372f;
        padding: 12px;
        text-align: left;
    }

    .gitbook-content table td {
        border: 1px solid #D9CFC7;
        padding: 12px;
    }

    .gitbook-content table tr:nth-child(even) {
        background: #F9F8F6;
    }

    .gitbook-content a {
        color: #C9B59C;
        text-decoration: none;
        transition: color 0.2s;
    }

    .gitbook-content a:hover {
        color: #3f372f;
        text-decoration: underline;
    }

    @media (max-width: 1024px) {
        .gitbook-container > aside:last-child {
            display: none;
        }
    }
</style>

<script>
// Filter pages based on search input
function filterPages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const pageItems = document.querySelectorAll('.page-item');
    const currentPage = document.querySelector('.current-page');
    let visibleChildrenCount = 0;
    let visibleSiblingsCount = 0;

    pageItems.forEach(item => {
        // Skip the current page, always show it
        if (item === currentPage) {
            return;
        }

        const link = item.querySelector('a[data-page-title]');
        if (!link) return;

        const title = link.getAttribute('data-page-title') || '';

        if (term === '' || title.includes(term)) {
            item.style.display = '';

            // Count visible items for each section
            if (item.closest('.children-list')) {
                visibleChildrenCount++;
            } else if (item.closest('.siblings-list')) {
                visibleSiblingsCount++;
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Update counts
    const childrenCount = document.querySelector('.children-count');
    if (childrenCount && term !== '') {
        childrenCount.textContent = `(${visibleChildrenCount})`;
    }

    const siblingsCount = document.querySelector('.siblings-count');
    if (siblingsCount && term !== '') {
        siblingsCount.textContent = `(${visibleSiblingsCount})`;
    }

    // Hide "show more" buttons when filtering
    const showMoreButtons = document.querySelectorAll('.children-section button, .siblings-section button');
    showMoreButtons.forEach(btn => {
        btn.style.display = term === '' ? '' : 'none';
    });

    // Show no results message if needed
    const childrenSection = document.querySelector('.children-section');
    const siblingsSection = document.querySelector('.siblings-section');

    if (term !== '' && visibleChildrenCount === 0 && visibleSiblingsCount === 0) {
        // Show a "no results" message if one doesn't exist
        let noResults = document.getElementById('no-results-message');
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'no-results-message';
            noResults.style.cssText = 'padding: 15px; text-align: center; color: #7b7268; font-size: 0.9rem; background: #F9F8F6; border-radius: 6px; margin-top: 10px;';
            noResults.textContent = 'KhÃ´ng tÃ¬m tháº¥y trang nÃ o';
            document.querySelector('.entry-tree-container').appendChild(noResults);
        }
        noResults.style.display = '';
    } else {
        const noResults = document.getElementById('no-results-message');
        if (noResults) {
            noResults.style.display = 'none';
        }
    }
}

// Show more children
function showMoreChildren(button) {
    const childrenList = button.closest('.children-section').querySelector('.children-list');
    const hiddenItems = childrenList.querySelectorAll('.hidden-item');

    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-item');
    });

    button.style.display = 'none';
}

// Show more siblings
function showMoreSiblings(button) {
    const siblingsList = button.closest('.siblings-section').querySelector('.siblings-list');
    const hiddenItems = siblingsList.querySelectorAll('.hidden-item');

    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-item');
    });

    button.style.display = 'none';
}
</script>
{% endblock %}
