{% extends 'base.html' %}
{% load static %}

{% block title %}{{ entry.title }} - Kiáº¿n Thá»©c{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
<link rel="stylesheet" href="{% static 'css/code-highlight.css' %}">
{% endblock %}

{% block content %}
<div class="gitbook-container">
    <!-- Left Sidebar -->
    <aside class="gitbook-sidebar">
        <h3>ğŸ“š Chá»§ Ä‘á»</h3>
        {% if entry.topic %}
        <div class="gitbook-sidebar-item" style="background: #D9CFC7; color: #3f372f;">
            ğŸ“Œ {{ entry.topic.name }}
        </div>
        {% endif %}

        <h3>ğŸ“„ Pages</h3>
        {% if entry.parent or sibling_pages %}
            {% if entry.parent %}
                <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}" class="gitbook-sidebar-item">
                    â† {{ entry.parent.title }}
                </a>
                <div style="padding-left: 15px;">
                    {% for child in entry.parent.children.all %}
                        <a href="{% url 'knowledge:entry_detail' child.slug %}" 
                           class="gitbook-sidebar-item {% if child.id == entry.id %}active{% endif %}">
                            {{ child.title|truncatewords:3 }}
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                {% for page in sibling_pages %}
                    <a href="{% url 'knowledge:entry_detail' page.slug %}" class="gitbook-sidebar-item">
                        {{ page.title|truncatewords:3 }}
                    </a>
                {% endfor %}
            {% endif %}
        {% endif %}

        <h3>âš™ï¸ Quáº£n lÃ½</h3>
        <a href="{% url 'knowledge:entry_list' %}" class="gitbook-sidebar-item">â† Danh sÃ¡ch</a>
        <a href="{% url 'knowledge:entry_update' entry.slug %}" class="gitbook-sidebar-item">âœï¸ Chá»‰nh sá»­a</a>
        <a href="{% url 'knowledge:entry_delete' entry.slug %}" class="gitbook-sidebar-item" onclick="return confirm('Báº¡n cháº¯c cháº¯n?')">ğŸ—‘ï¸ XÃ³a</a>
    </aside>

    <!-- Main Content -->
    <main class="gitbook-main">
        <!-- Breadcrumb -->
        <div class="gitbook-breadcrumb" style="margin-bottom: 20px; font-size: 0.9rem; color: #7b7268;">
            <a href="{% url 'knowledge:entry_list' %}" style="color: #C9B59C; text-decoration: none;">Kiáº¿n Thá»©c</a>
            {% if entry.topic %} / <a href="?topic={{ entry.topic.id }}" style="color: #C9B59C; text-decoration: none;">{{ entry.topic.name }}</a>{% endif %}
            {% if entry.parent %} / <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}" style="color: #C9B59C; text-decoration: none;">{{ entry.parent.title }}</a>{% endif %}
            / <span>{{ entry.title }}</span>
        </div>

        <!-- Header -->
        <div class="gitbook-header" style="margin-bottom: 40px;">
            <div>
                <h1 class="gitbook-title" style="margin: 0 0 10px 0;">
                    {{ entry.title }}
                    {% if entry.is_favorite %}<span style="font-size: 1.2rem;">â­</span>{% endif %}
                </h1>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">
                    {% if entry.entry_type %}
                    <span style="padding: 4px 12px; background: #F9F8F6; color: #7b7268; border-radius: 4px; font-size: 0.85rem;">
                        ğŸ“Œ {{ entry.get_entry_type_display }}
                    </span>
                    {% endif %}
                    <span style="padding: 4px 12px; background: #F9F8F6; color: #7b7268; border-radius: 4px; font-size: 0.85rem;">
                        ğŸ“… {{ entry.updated_at|date:"d/m/Y H:i" }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Summary -->
        {% if entry.summary %}
        <div style="background: linear-gradient(135deg, rgba(201, 181, 156, 0.1) 0%, rgba(217, 207, 199, 0.1) 100%); padding: 20px; border-left: 4px solid #C9B59C; border-radius: 6px; margin-bottom: 40px;">
            <p style="margin: 0; line-height: 1.7; color: #3f372f;">{{ entry.summary }}</p>
        </div>
        {% endif %}

        <!-- Tags -->
        {% if entry.tags %}
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px;">
            {% for tag in entry.tags|split:"," %}
            <span style="padding: 6px 14px; background: #F9F8F6; color: #7b7268; border-radius: 16px; font-size: 0.9rem;">
                #{{ tag|trim }}
            </span>
            {% endfor %}
        </div>
        {% endif %}

        <div style="display: grid; grid-template-columns: 1fr 250px; gap: 40px;">
            <!-- Main Content -->
            <div>
                <article class="gitbook-content">
                    {{ content_html|safe }}
                </article>

                <!-- Source URL -->
                {% if entry.source_url %}
                <div style="margin-top: 40px; padding: 20px; background: #F9F8F6; border-radius: 8px; border-left: 4px solid #C9B59C;">
                    <h4 style="margin: 0 0 10px 0; color: #3f372f;">ğŸ”— Nguá»“n</h4>
                    <a href="{{ entry.source_url }}" target="_blank" style="color: #C9B59C; text-decoration: none; word-break: break-all;">
                        {{ entry.source_url }}
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Right Sidebar: Table of Contents -->
            <aside style="position: sticky; top: 120px; height: fit-content;">
                {% if toc_items %}
                <div class="toc-container">
                    <h3 style="margin: 0 0 15px 0; font-size: 0.95rem;">ğŸ“‘ Má»¥c lá»¥c</h3>
                    <ul class="toc-list">
                        {% for item in toc_items %}
                        <li class="level-{{ item.level }}">
                            <a href="#{{ item.id }}">{{ item.text }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Related Pages -->
                {% if entry.children.all %}
                <div style="margin-top: 30px; padding: 15px; background: #F9F8F6; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #3f372f;">ğŸ“š Trang con</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        {% for child in entry.children.all %}
                        <li style="margin-bottom: 8px;">
                            <a href="{% url 'knowledge:entry_detail' child.slug %}" 
                               style="color: #C9B59C; text-decoration: none; font-size: 0.9rem;">
                                â†’ {{ child.title|truncatewords:3 }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </aside>
        </div>
    </main>
</div>

<style>
    .gitbook-content {
        line-height: 1.8;
        color: #3f372f;
    }

    .gitbook-content h1 {
        font-size: 2rem;
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #D9CFC7;
    }

    .gitbook-content h2 {
        font-size: 1.6rem;
        margin: 35px 0 15px 0;
        color: #3f372f;
    }

    .gitbook-content h3 {
        font-size: 1.3rem;
        margin: 25px 0 12px 0;
        color: #3f372f;
    }

    .gitbook-content h4, .gitbook-content h5, .gitbook-content h6 {
        margin: 20px 0 10px 0;
        color: #3f372f;
    }

    .gitbook-content p {
        margin: 15px 0;
    }

    .gitbook-content ul, .gitbook-content ol {
        margin: 15px 0;
        padding-left: 30px;
    }

    .gitbook-content li {
        margin: 8px 0;
    }

    .gitbook-content code {
        background: #F9F8F6;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #C9B59C;
    }

    .gitbook-content pre {
        background: #3f372f;
        color: #F9F8F6;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 20px 0;
    }

    .gitbook-content pre code {
        background: none;
        padding: 0;
        color: #F9F8F6;
    }

    .gitbook-content blockquote {
        border-left: 4px solid #C9B59C;
        padding-left: 20px;
        margin: 20px 0;
        color: #7b7268;
        font-style: italic;
    }

    .gitbook-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .gitbook-content table th {
        background: #D9CFC7;
        color: #3f372f;
        padding: 12px;
        text-align: left;
    }

    .gitbook-content table td {
        border: 1px solid #D9CFC7;
        padding: 12px;
    }

    .gitbook-content table tr:nth-child(even) {
        background: #F9F8F6;
    }

    .gitbook-content a {
        color: #C9B59C;
        text-decoration: none;
        transition: color 0.2s;
    }

    .gitbook-content a:hover {
        color: #3f372f;
        text-decoration: underline;
    }

    @media (max-width: 1024px) {
        .gitbook-container > aside:last-child {
            display: none;
        }
    }
</style>
{% endblock %}
