{% extends 'base.html' %}
{% load static %}
{% load knowledge_extras %}

{% block title %}{{ entry.title }} - Knowledge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
<link rel="stylesheet" href="{% static 'css/code-highlight.css' %}">
{% endblock %}

{% block content %}
<div class="gitbook-container" style="background: #F9F8F6; min-height: 100vh;">
    <!-- Left Sidebar - Management -->
    <aside class="gitbook-sidebar" style="width: 230px; padding: 20px;">
        <div style="margin-bottom: 20px;">
            <a href="{% url 'knowledge:entry_list' %}"
               style="display: block; padding: 10px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                ‚Üê All Entries
            </a>
        </div>

        <h3 style="margin-top: 10px;">This Page</h3>
        <a href="{% url 'knowledge:entry_update' entry.slug %}" class="gitbook-sidebar-item">Edit</a>
        <a href="{% url 'knowledge:entry_delete' entry.slug %}" class="gitbook-sidebar-item" onclick="return confirm('Are you sure you want to delete?')">Delete</a>
        <a href="{% url 'knowledge:entry_create' %}?parent={{ entry.id }}" class="gitbook-sidebar-item">Add Child Page</a>

        <h3 style="margin-top: 20px;">Management</h3>
        <a href="{% url 'knowledge:search' %}" class="gitbook-sidebar-item">Search</a>
        <a href="{% url 'knowledge:topic_list' %}" class="gitbook-sidebar-item">Topics</a>
        <a href="{% url 'knowledge:resource_list' %}" class="gitbook-sidebar-item">Resources</a>
    </aside>

    <!-- Main Content -->
    <main class="gitbook-main" style="max-width: 1200px; margin: 0 auto; padding: 20px 40px 40px 40px;">
        <!-- Breadcrumb - Minimal -->
        <div style="margin-bottom: 30px; font-size: 0.85rem; color: #7b7268;">
            <a href="{% url 'knowledge:entry_list' %}" style="color: #7b7268; text-decoration: none; transition: color 0.2s;">Knowledge</a>
            {% if entry.topic %} <span style="color: #D9CFC7;">‚Ä∫</span> <a href="?topic={{ entry.topic.id }}" style="color: #7b7268; text-decoration: none;">{{ entry.topic.name }}</a>{% endif %}
            {% if entry.parent %} <span style="color: #D9CFC7;">‚Ä∫</span> <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}" style="color: #7b7268; text-decoration: none;">{{ entry.parent.title|truncatewords:5 }}</a>{% endif %}
        </div>

        <!-- Title - Large and Clean -->
        <h1 style="font-size: 3rem; font-weight: 700; margin: 0 0 15px 0; color: #3f372f; line-height: 1.2;">
            {{ entry.title }}{% if entry.is_favorite %} <span style="color: #C9B59C;">‚≠ê</span>{% endif %}
        </h1>

        <!-- Summary - Minimal if present -->
        {% if entry.summary %}
        <p style="font-size: 1.1rem; color: #7b7268; margin: 0 0 30px 0; line-height: 1.6;">
            {{ entry.summary }}
        </p>
        {% endif %}

        <!-- Meta Info - Very minimal -->
        <div style="display: flex; gap: 15px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #EFE9E3; font-size: 0.85rem; color: #7b7268;">
            {% if entry.entry_type %}
            <span>{{ entry.get_entry_type_display }}</span>
            {% endif %}
            <span>‚Ä¢</span>
            <span>{{ entry.updated_at|date:"d/m/Y" }}</span>
            {% if entry.tags %}
            <span>‚Ä¢</span>
            <span>
                {% for tag in entry.tags|split:"," %}
                    #{{ tag|trim }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </span>
            {% endif %}
        </div>

        <!-- Children Pages as Cards (if this is a parent page) -->
        {% if entry.children.all %}
        <div style="margin-bottom: 50px;">
            <p style="color: #7b7268; font-size: 0.95rem; margin-bottom: 20px;">Pages in this section:</p>
            <div style="display: grid; gap: 15px;">
                {% for child in entry.children.all %}
                <a href="{% url 'knowledge:entry_detail' child.slug %}"
                   style="display: flex; align-items: center; gap: 15px; padding: 20px; background: white; border: 1px solid #EFE9E3; border-radius: 8px; text-decoration: none; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#C9B59C'; this.style.transform='translateX(5px)';"
                   onmouseout="this.style.borderColor='#EFE9E3'; this.style.transform='translateX(0)';">
                    <div style="font-size: 1.5rem;">üìÑ</div>
                    <div>
                        <div style="font-weight: 600; color: #3f372f; margin-bottom: 4px;">{{ child.title }}</div>
                        {% if child.summary %}
                        <div style="font-size: 0.9rem; color: #7b7268;">{{ child.summary|truncatewords:15 }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Main Article Content -->
        <article class="gitbook-content" style="margin-bottom: 50px;">
            {{ content_html|safe }}
        </article>

        <!-- Source URL - Minimal -->
        {% if entry.source_url %}
        <div style="margin: 40px 0; padding: 15px 20px; background: #F9F8F6; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 6px;">Reference Source</div>
            <a href="{{ entry.source_url }}" target="_blank" style="color: #C9B59C; text-decoration: none; word-break: break-all; font-size: 0.9rem;">
                {{ entry.source_url }}
            </a>
        </div>
        {% endif %}

        <!-- Edit Button - Floating at bottom -->
        <div style="margin-top: 60px; padding-top: 30px; border-top: 1px solid #EFE9E3;">
            <a href="{% url 'knowledge:entry_update' entry.slug %}"
               style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #F9F8F6; color: #7b7268; border: 1px solid #D9CFC7; border-radius: 6px; text-decoration: none; font-size: 0.9rem; transition: all 0.2s;"
               onmouseover="this.style.background='#EFE9E3';"
               onmouseout="this.style.background='#F9F8F6';">
                Edit this page
            </a>
        </div>
    </main>

    <!-- Right Sidebar - Page Structure -->
    <aside id="right-sidebar" style="width: 320px; position: fixed; right: 0; top: 100px; height: calc(100vh - 100px); background: #F9F8F6; border-left: 1px solid #D9CFC7; padding: 20px; overflow-y: auto; transition: transform 0.3s ease; transform: translateX(0); z-index: 90;">
        <!-- Topic Info -->
        {% if entry.topic %}
        <div style="margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.1) 0%, rgba(217, 207, 199, 0.1) 100%); border-radius: 8px; border-left: 3px solid #C9B59C;">
            <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 600;">Topic</div>
            <div style="font-weight: 600; color: #3f372f; font-size: 1.05rem;">{{ entry.topic.name }}</div>
        </div>
        {% endif %}

        <!-- Page Structure -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="font-size: 0.9rem; font-weight: 700; color: #3f372f; margin: 0;">Page Structure</h3>
                <button onclick="toggleRightSidebar()" style="background: #EFE9E3; border: 1px solid #D9CFC7; color: #7b7268; cursor: pointer; font-size: 0.85rem; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#D9CFC7';" onmouseout="this.style.background='#EFE9E3';" title="Hide/show structure">
                    Hide
                </button>
            </div>

            <div style="margin-bottom: 15px;">
                <input type="text" id="page-search" placeholder="Search pages..."
                       style="width: 100%; padding: 8px 10px; border: 1px solid #D9CFC7; border-radius: 6px; font-size: 0.85rem; color: #3f372f; background: white; transition: all 0.2s;"
                       onkeyup="filterPages(this.value)"
                       onfocus="this.style.borderColor='#C9B59C'; this.style.boxShadow='0 0 0 3px rgba(201, 181, 156, 0.1)';"
                       onblur="this.style.borderColor='#D9CFC7'; this.style.boxShadow='none';">
            </div>

            <div class="entry-tree-container" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                {% if entry.parent %}
                    <div class="page-item" style="margin-bottom: 8px;">
                        <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}"
                           class="gitbook-sidebar-item"
                           style="font-size: 0.85rem; opacity: 0.7; padding: 6px 8px;"
                           data-page-title="{{ entry.parent.title|lower }}">
                            ‚¨ÜÔ∏è {{ entry.parent.title|truncatewords:4 }}
                        </a>
                    </div>
                {% endif %}

                <div class="page-item current-page" style="margin: 8px 0; padding: 10px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.15) 0%, rgba(217, 207, 199, 0.15) 100%); border-left: 3px solid #C9B59C; border-radius: 6px;">
                    <div style="font-weight: 600; color: #3f372f; font-size: 0.9rem;">
                        üìÑ {{ entry.title }}{% if entry.is_favorite %} ‚≠ê{% endif %}
                    </div>
                </div>

                {% if entry.children.all %}
                    <div class="children-section" style="margin-left: 12px; border-left: 2px solid #D9CFC7; padding-left: 8px;">
                        <div style="font-size: 0.8rem; color: #7b7268; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                            <span>Child Pages ({{ entry.children.all|length }})</span>
                            {% if entry.children.all|length > 5 %}
                            <button onclick="toggleAllChildren(this)" data-expanded="false"
                                    style="padding: 3px 6px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.background='#D9CFC7';"
                                    onmouseout="this.style.background='#EFE9E3';">
                                All
                            </button>
                            {% endif %}
                        </div>
                        <div class="children-list">
                            {% for child in entry.children.all %}
                                <div class="tree-item {% if forloop.counter > 5 %}hidden-item{% endif %}" style="margin-bottom: 2px; {% if forloop.counter > 5 %}display: none;{% endif %}">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        {% if child.children.all %}
                                        <button class="tree-toggle" onclick="toggleTreeNode(this)" data-collapsed="true"
                                                style="width: 14px; height: 14px; border: none; background: none; cursor: pointer; font-size: 9px; padding: 0; color: #7b7268; transition: transform 0.2s;">
                                            ‚ñ∂
                                        </button>
                                        {% else %}
                                        <span style="width: 14px; display: inline-block;"></span>
                                        {% endif %}
                                        <a href="{% url 'knowledge:entry_detail' child.slug %}"
                                           class="page-item gitbook-sidebar-item"
                                           style="flex: 1; padding: 5px 6px; margin: 0; border-radius: 4px; font-size: 0.85rem;"
                                           data-page-title="{{ child.title|lower }}">
                                            üìÑ {{ child.title|truncatewords:4 }}
                                            {% if child.is_favorite %} ‚≠ê{% endif %}
                                            {% if child.children.all %}<span style="margin-left: 4px; font-size: 0.7rem; color: #7b7268;">({{ child.children.all|length }})</span>{% endif %}
                                        </a>
                                    </div>
                                    {% if child.children.all %}
                                    <div class="tree-children" style="display: none; margin-left: 18px; border-left: 2px solid #E5DDD5; padding-left: 5px; margin-top: 2px;">
                                        {% for grandchild in child.children.all %}
                                        <a href="{% url 'knowledge:entry_detail' grandchild.slug %}"
                                           class="page-item gitbook-sidebar-item"
                                           style="display: block; padding: 4px 6px; margin-bottom: 2px; border-radius: 4px; font-size: 0.8rem; opacity: 0.9;"
                                           data-page-title="{{ grandchild.title|lower }}">
                                            üìÑ {{ grandchild.title|truncatewords:3 }}
                                            {% if grandchild.is_favorite %} ‚≠ê{% endif %}
                                        </a>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        {% if entry.children.all|length > 5 %}
                        <button onclick="showMoreChildren(this)"
                                style="margin-top: 8px; padding: 5px 8px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; width: 100%;"
                                onmouseover="this.style.background='#D9CFC7';"
                                onmouseout="this.style.background='#EFE9E3';">
                            Show {{ entry.children.all|length|add:"-5" }} more
                        </button>
                        {% endif %}
                    </div>
                {% endif %}

                {% if sibling_pages %}
                    <div class="siblings-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #D9CFC7;">
                        <div style="font-size: 0.8rem; color: #7b7268; margin-bottom: 8px; font-weight: 600;">
                            {% if entry.parent %}Sibling Pages{% else %}Same Topic{% endif %} ({{ sibling_pages|length }})
                        </div>
                        <div class="siblings-list">
                            {% for page in sibling_pages %}
                                <a href="{% url 'knowledge:entry_detail' page.slug %}"
                                   class="page-item gitbook-sidebar-item {% if forloop.counter > 5 %}hidden-item{% endif %}"
                                   style="margin-bottom: 3px; opacity: 0.8; padding: 5px 6px; font-size: 0.85rem; {% if forloop.counter > 5 %}display: none;{% endif %}"
                                   data-page-title="{{ page.title|lower }}">
                                    üìÑ {{ page.title|truncatewords:4 }}
                                    {% if page.is_favorite %} ‚≠ê{% endif %}
                                </a>
                            {% endfor %}
                        </div>
                        {% if sibling_pages|length > 5 %}
                        <button onclick="showMoreSiblings(this)"
                                style="margin-top: 8px; padding: 5px 8px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; width: 100%;"
                                onmouseover="this.style.background='#D9CFC7';"
                                onmouseout="this.style.background='#EFE9E3';">
                            Show {{ sibling_pages|length|add:"-5" }} more
                        </button>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </aside>

    <!-- Toggle Right Sidebar Button -->
    <button id="show-right-sidebar" onclick="toggleRightSidebar()" style="position: fixed; right: 12px; top: 140px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border: none; border-radius: 999px; padding: 10px 14px; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: all 0.3s; z-index: 100; font-size: 0.85rem; font-weight: 600;" onmouseover="this.style.transform='translateY(-2px)';" onmouseout="this.style.transform='translateY(0)';">
        Structure
    </button>
</div>

<style>
    .gitbook-content {
        line-height: 1.8;
        color: #3f372f;
    }

    .gitbook-content h1 {
        font-size: 2rem;
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #D9CFC7;
    }

    .gitbook-content h2 {
        font-size: 1.6rem;
        margin: 35px 0 15px 0;
        color: #3f372f;
    }

    .gitbook-content h3 {
        font-size: 1.3rem;
        margin: 25px 0 12px 0;
        color: #3f372f;
    }

    .gitbook-content h4, .gitbook-content h5, .gitbook-content h6 {
        margin: 20px 0 10px 0;
        color: #3f372f;
    }

    .gitbook-content p {
        margin: 15px 0;
    }

    .gitbook-content ul, .gitbook-content ol {
        margin: 15px 0;
        padding-left: 30px;
    }

    .gitbook-content li {
        margin: 8px 0;
    }

    .gitbook-content code {
        background: #F9F8F6;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #C9B59C;
    }

    .gitbook-content pre {
        background: #3f372f;
        color: #F9F8F6;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 20px 0;
    }

    .gitbook-content pre code {
        background: none;
        padding: 0;
        color: #F9F8F6;
    }

    .gitbook-content blockquote {
        border-left: 4px solid #C9B59C;
        padding-left: 20px;
        margin: 20px 0;
        color: #7b7268;
        font-style: italic;
    }

    .gitbook-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .gitbook-content table th {
        background: #D9CFC7;
        color: #3f372f;
        padding: 12px;
        text-align: left;
    }

    .gitbook-content table td {
        border: 1px solid #D9CFC7;
        padding: 12px;
    }

    .gitbook-content table tr:nth-child(even) {
        background: #F9F8F6;
    }

    .gitbook-content a {
        color: #C9B59C;
        text-decoration: none;
        transition: color 0.2s;
    }

    .gitbook-content a:hover {
        color: #3f372f;
        text-decoration: underline;
    }

    @media (max-width: 1024px) {
        .gitbook-container > aside:last-child {
            display: none;
        }
    }
</style>

<script>
function toggleRightSidebar() {
    const sidebar = document.getElementById('right-sidebar');
    const button = document.getElementById('show-right-sidebar');

    const isHidden = sidebar.style.transform === 'translateX(100%)';

    if (isHidden) {
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.borderLeft = '1px solid #D9CFC7';
        button.textContent = 'Structure';
    } else {
        sidebar.style.transform = 'translateX(100%)';
        sidebar.style.borderLeft = 'none';
        button.textContent = 'Show Structure';
    }
}

// Filter pages based on search input
function filterPages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const pageItems = document.querySelectorAll('.page-item');
    const currentPage = document.querySelector('.current-page');
    let visibleChildrenCount = 0;
    let visibleSiblingsCount = 0;

    pageItems.forEach(item => {
        // Skip the current page, always show it
        if (item === currentPage) {
            return;
        }

        const link = item.querySelector('a[data-page-title]');
        if (!link) return;

        const title = link.getAttribute('data-page-title') || '';

        if (term === '' || title.includes(term)) {
            item.style.display = '';

            // Count visible items for each section
            if (item.closest('.children-list')) {
                visibleChildrenCount++;
            } else if (item.closest('.siblings-list')) {
                visibleSiblingsCount++;
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Update counts
    const childrenCount = document.querySelector('.children-count');
    if (childrenCount && term !== '') {
        childrenCount.textContent = `(${visibleChildrenCount})`;
    }

    const siblingsCount = document.querySelector('.siblings-count');
    if (siblingsCount && term !== '') {
        siblingsCount.textContent = `(${visibleSiblingsCount})`;
    }

    // Hide "show more" buttons when filtering
    const showMoreButtons = document.querySelectorAll('.children-section button, .siblings-section button');
    showMoreButtons.forEach(btn => {
        btn.style.display = term === '' ? '' : 'none';
    });

    // Show no results message if needed
    const childrenSection = document.querySelector('.children-section');
    const siblingsSection = document.querySelector('.siblings-section');

    if (term !== '' && visibleChildrenCount === 0 && visibleSiblingsCount === 0) {
        // Show a "no results" message if one doesn't exist
        let noResults = document.getElementById('no-results-message');
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'no-results-message';
            noResults.style.cssText = 'padding: 15px; text-align: center; color: #7b7268; font-size: 0.9rem; background: #F9F8F6; border-radius: 6px; margin-top: 10px;';
            noResults.textContent = 'No pages found';
            document.querySelector('.entry-tree-container').appendChild(noResults);
        }
        noResults.style.display = '';
    } else {
        const noResults = document.getElementById('no-results-message');
        if (noResults) {
            noResults.style.display = 'none';
        }
    }
}

// Show more children
function showMoreChildren(button) {
    const childrenList = button.closest('.children-section').querySelector('.children-list');
    const hiddenItems = childrenList.querySelectorAll('.hidden-item');

    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-item');
    });

    button.style.display = 'none';
}

// Show more siblings
function showMoreSiblings(button) {
    const siblingsList = button.closest('.siblings-section').querySelector('.siblings-list');
    const hiddenItems = siblingsList.querySelectorAll('.hidden-item');

    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-item');
    });

    button.style.display = 'none';
}

function toggleTreeNode(button) {
    const treeItem = button.closest('.tree-item');
    const childrenContainer = treeItem.querySelector('.tree-children');

    if (!childrenContainer) return;

    const isCollapsed = button.dataset.collapsed === 'true';
    button.dataset.collapsed = !isCollapsed;

    if (isCollapsed) {
        childrenContainer.style.display = 'block';
        button.textContent = '‚ñº';
    } else {
        childrenContainer.style.display = 'none';
        button.textContent = '‚ñ∂';
    }
}

function toggleAllChildren(button) {
    const isExpanded = button.dataset.expanded === 'true';
    const childrenSection = button.closest('.children-section');
    const allToggles = childrenSection.querySelectorAll('.tree-toggle');

    allToggles.forEach(toggle => {
        const childrenContainer = toggle.closest('.tree-item').querySelector('.tree-children');
        if (childrenContainer) {
            if (isExpanded) {
                childrenContainer.style.display = 'none';
                toggle.textContent = '‚ñ∂';
                toggle.dataset.collapsed = 'true';
            } else {
                childrenContainer.style.display = 'block';
                toggle.textContent = '‚ñº';
                toggle.dataset.collapsed = 'false';
            }
        }
    });

    button.dataset.expanded = !isExpanded;
    button.textContent = isExpanded ? 'All' : 'Collapse';
}
</script>
{% endblock %}
