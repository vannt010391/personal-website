{% extends 'base.html' %}
{% load static %}
{% load knowledge_tree %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Entry{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
<!-- Editor.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest/dist/editor.min.css">
{% endblock %}

{% block content %}
<style>
body {
    margin: 0 !important;
    padding: 0 !important;
}
main.container {
    padding: 0 !important;
}
</style>

<!-- Messages Display -->
{% if messages %}
<div style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 600px;">
    {% for message in messages %}
    <div class="alert-message {{ message.tags }}" style="padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.3s ease-out; font-weight: 500; {% if 'success' in message.tags %}background-color: #D4EDDA !important; border: 1px solid #C3E6CB !important; color: #155724 !important;{% elif 'error' in message.tags %}background-color: #F8D7DA !important; border: 1px solid #F5C6CB !important; color: #721C24 !important;{% elif 'warning' in message.tags %}background-color: #FFF3CD !important; border: 1px solid #FFEAA7 !important; color: #856404 !important;{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
<style>
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.alert-message.success {
    background-color: #D4EDDA !important;
    border: 1px solid #C3E6CB !important;
    color: #155724 !important;
}
.alert-message.error {
    background-color: #F8D7DA !important;
    border: 1px solid #F5C6CB !important;
    color: #721C24 !important;
}
.alert-message.warning {
    background-color: #FFF3CD !important;
    border: 1px solid #FFEAA7 !important;
    color: #856404 !important;
}
</style>
{% endif %}

<div style="min-height: 100vh; background: #F9F8F6; margin: 0; padding: 0;">
    <div style="display: flex; margin-top: 20px; width: 100%; box-sizing: border-box;">
        <!-- Left Sidebar - Management -->
        <aside style="width: 230px; min-height: calc(100vh - 100px); background: #F9F8F6; border-right: 1px solid #D9CFC7; padding: 20px; overflow-y: auto;">
            {% if object %}
            {% with entry=object %}
            <div style="margin-bottom: 20px;">
                <a href="{% url 'knowledge:entry_list' %}"
                   style="display: block; padding: 10px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                    ← All Entries
                </a>
            </div>

            <!-- This Page Section -->
            <h3 style="font-size: 0.9rem; font-weight: 700; color: #3f372f; margin-bottom: 12px;">This Page</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 25px;">
                <button type="button" onclick="toggleSettings()" class="gitbook-sidebar-item" style="background: transparent; border: none; width: 100%; text-align: left; cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#EFE9E3';" onmouseout="this.style.background='transparent';">
                    Settings
                </button>
                <a href="{% url 'knowledge:entry_detail' entry.slug %}" class="gitbook-sidebar-item" style="padding: 8px 12px; border-radius: 4px; transition: all 0.2s; text-decoration: none; color: #7b7268;" onmouseover="this.style.background='#EFE9E3';" onmouseout="this.style.background='transparent';">Cancel</a>
                <button type="submit" form="entry-form" id="top-submit-btn" class="gitbook-sidebar-item" style="background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); border: none; width: 100%; text-align: left; cursor: pointer; font-weight: 600; color: white; padding: 10px 12px; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.opacity='0.9';" onmouseout="this.style.opacity='1';">
                    Update
                </button>
            </div>

            <!-- Quick Actions -->
            <h3 style="font-size: 0.9rem; font-weight: 700; color: #3f372f; margin-bottom: 12px;">Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 25px;">
                <a href="{% url 'knowledge:entry_create' %}?parent={{ entry.id }}" style="padding: 10px 12px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-decoration: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; text-align: center;" onmouseover="this.style.background='#EFE9E3'; this.style.borderColor='#C9B59C';" onmouseout="this.style.background='white'; this.style.borderColor='#D9CFC7';">
                    Add Child Page
                </a>
            </div>

            <!-- Management Section -->
            <h3 style="font-size: 0.9rem; font-weight: 700; color: #3f372f; margin-bottom: 12px;">Management</h3>
            <div style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 25px;">
                <a href="{% url 'knowledge:search' %}" style="padding: 8px 12px; color: #7b7268; text-decoration: none; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#EFE9E3';" onmouseout="this.style.background='transparent';">Search</a>
                <a href="{% url 'knowledge:topic_list' %}" style="padding: 8px 12px; color: #7b7268; text-decoration: none; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#EFE9E3';" onmouseout="this.style.background='transparent';">Topics</a>
                <a href="{% url 'knowledge:resource_list' %}" style="padding: 8px 12px; color: #7b7268; text-decoration: none; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#EFE9E3';" onmouseout="this.style.background='transparent';">Resources</a>
            </div>
            {% endwith %}
            {% elif parent_entry and not object %}
            <div style="margin-bottom: 20px;">
                <a href="{% url 'knowledge:entry_list' %}"
                   style="display: block; padding: 10px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                    ← All Entries
                </a>
            </div>

            {% if parent_entry.topic %}
            <div style="margin-bottom: 20px; padding: 12px; background: #EFE9E3; border-radius: 6px;">
                <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 4px;">Topic:</div>
                <div style="font-weight: 600; color: #3f372f;">{{ parent_entry.topic.name }}</div>
            </div>
            {% endif %}

            <h3>Page Structure</h3>

            <div style="margin-bottom: 15px;">
                <input type="text" id="page-search" placeholder="Find page..."
                       style="width: 100%; padding: 10px 12px; border: 1px solid #D9CFC7; border-radius: 6px; font-size: 0.9rem; color: #3f372f; background: white; transition: all 0.2s;"
                       onkeyup="filterSidebarPages(this.value)"
                       onfocus="this.style.borderColor='#C9B59C'; this.style.boxShadow='0 0 0 3px rgba(201, 181, 156, 0.1)';"
                       onblur="this.style.borderColor='#D9CFC7'; this.style.boxShadow='none';">
            </div>

            <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 600;">Parent Page:</div>
            <div class="entry-tree-container">
                <div class="sidebar-tree-item" style="margin-bottom: 2px;">
                    <div class="sidebar-tree-node" style="display: flex; align-items: center; gap: 4px;">
                        {% with children=parent_entry.children.all %}
                        {% if children %}
                            <button class="sidebar-tree-toggle" onclick="toggleSidebarEntry(this)" data-collapsed="false"
                                    style="width: 16px; height: 16px; border: none; background: none; cursor: pointer; font-size: 10px; padding: 0; color: #7b7268; transition: transform 0.2s;">
                                v
                            </button>
                        {% else %}
                            <span style="width: 16px; display: inline-block;"></span>
                        {% endif %}
                        {% endwith %}

                                <a href="{% url 'knowledge:entry_detail' parent_entry.slug %}"
                                    class="sidebar-tree-link"
                           style="flex: 1; padding: 6px 8px; text-decoration: none; color: #7b7268; border-radius: 4px; transition: all 0.2s; font-size: 0.9rem; display: block;">
                            {{ parent_entry.title|truncatewords:5 }}
                            {% if parent_entry.is_favorite %}<span style="margin-left: 4px; font-size: 0.85rem;">★</span>{% endif %}
                        </a>
                    </div>

                    <div class="sidebar-tree-children" style="margin-left: 20px; border-left: 2px solid #D9CFC7; padding-left: 5px;">
                        <div class="sidebar-tree-item" style="margin-bottom: 2px;">
                            <div class="sidebar-tree-node" style="display: flex; align-items: center; gap: 4px;">
                                <span style="width: 16px; display: inline-block;"></span>
                                <span data-page-title="creating new child page" style="flex: 1; padding: 6px 8px; border-radius: 4px; border: 1px dashed #C9B59C; background: #FAF7F2; color: #7b7268; font-size: 0.85rem; display: block;">
                                    Creating new child page
                                </span>
                            </div>
                        </div>

                        {% for child in parent_entry.children.all %}
                        <div class="sidebar-tree-item" style="margin-bottom: 2px;">
                            <div class="sidebar-tree-node" style="display: flex; align-items: center; gap: 4px;">
                                <span style="width: 16px; display: inline-block;"></span>
                                <a href="{% url 'knowledge:entry_detail' child.slug %}"
                                   class="sidebar-tree-link"
                                   data-page-title="{{ child.title|lower }}"
                                   style="flex: 1; padding: 6px 8px; text-decoration: none; color: #7b7268; border-radius: 4px; transition: all 0.2s; font-size: 0.9rem; display: block;">
                                    {{ child.title|truncatewords:5 }}
                                    {% if child.is_favorite %}<span style="margin-left: 4px; font-size: 0.85rem;">★</span>{% endif %}
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 25px;">Management</h3>
            <a href="{% url 'knowledge:search' %}" class="gitbook-sidebar-item">Search</a>
            <a href="{% url 'knowledge:topic_list' %}" class="gitbook-sidebar-item">Topics</a>
            <a href="{% url 'knowledge:resource_list' %}" class="gitbook-sidebar-item">Resources</a>

            <h3 style="margin-top: 20px;">This Page</h3>
            <button type="button" onclick="toggleSettings()" class="gitbook-sidebar-item" style="background: transparent; border: none; width: 100%; text-align: left; cursor: pointer;">
                Settings
            </button>
            <a href="{% url 'knowledge:entry_detail' parent_entry.slug %}" class="gitbook-sidebar-item">Cancel</a>
            <button type="submit" form="entry-form" id="top-submit-btn" class="gitbook-sidebar-item" style="background: transparent; border: none; width: 100%; text-align: left; cursor: pointer; font-weight: 600; color: #C9B59C;">
                Create Page
            </button>

            <style>
                .sidebar-tree-link:hover {
                    background: #EFE9E3;
                    color: #C9B59C;
                }

                .sidebar-tree-toggle.collapsed {
                    transform: rotate(-90deg);
                }

                .sidebar-tree-children.collapsed {
                    display: none;
                }

                .entry-tree-container {
                    max-height: calc(100vh - 450px);
                    overflow-y: auto;
                    padding-right: 5px;
                }

                .entry-tree-container::-webkit-scrollbar {
                    width: 6px;
                }

                .entry-tree-container::-webkit-scrollbar-track {
                    background: #F9F8F6;
                }

                .entry-tree-container::-webkit-scrollbar-thumb {
                    background: #D9CFC7;
                    border-radius: 3px;
                }

                .entry-tree-container::-webkit-scrollbar-thumb:hover {
                    background: #C9B59C;
                }
            </style>
            {% else %}
            <!-- Management Section -->
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 0.8rem; font-weight: 700; color: #7b7268; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    MANAGEMENT
                </h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="{% url 'knowledge:entry_create' %}" style="padding: 10px 14px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-decoration: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#EFE9E3'; this.style.borderColor='#C9B59C';" onmouseout="this.style.background='white'; this.style.borderColor='#D9CFC7';">
                        Create Note
                    </a>
                    <a href="{% url 'knowledge:topic_create' %}" style="padding: 10px 14px; background: white; border: 1px solid #D9CFC7; color: #7b7268; text-decoration: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#EFE9E3'; this.style.borderColor='#C9B59C';" onmouseout="this.style.background='white'; this.style.borderColor='#D9CFC7';">
                        Create Topic
                    </a>
                </div>
            </div>

            <h3 style="margin-top: 20px;">This Page</h3>
            <button type="button" onclick="toggleSettings()" class="gitbook-sidebar-item" style="background: transparent; border: none; width: 100%; text-align: left; cursor: pointer;">
                Settings
            </button>
            <a href="{% url 'knowledge:entry_list' %}" class="gitbook-sidebar-item">Cancel</a>
            <button type="submit" form="entry-form" id="top-submit-btn" class="gitbook-sidebar-item" style="background: transparent; border: none; width: 100%; text-align: left; cursor: pointer; font-weight: 600; color: #C9B59C;">
                Create Page
            </button>
            {% endif %}

        </aside>

        <!-- Main Content Area -->
        <main style="flex: 1; padding: 20px 40px 40px 40px; max-width: 1200px; margin: 0 auto;">
            <!-- Form starts here -->
            <form method="post" id="entry-form">
            {% csrf_token %}

            <!-- Settings Sidebar - Sliding from right -->
            <div id="settings-sidebar" style="position: fixed; top: 60px; right: -350px; width: 320px; height: calc(100vh - 60px); background: white; border-left: 1px solid #D9CFC7; padding: 20px; overflow-y: auto; transition: right 0.3s; z-index: 999; box-shadow: -2px 0 10px rgba(0,0,0,0.1); box-sizing: border-box;">
                <h3 style="margin: 0 0 20px 0; color: #3f372f; font-size: 1.1rem;">Advanced Settings</h3>
            <div style="display: grid; gap: 20px;">
                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Slug (URL)</label>
                    {{ form.slug }}
                    <small style="color: #7b7268; font-size: 0.75rem; display: block; margin-top: 4px;">Leave blank to auto-generate</small>
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Topic</label>
                    {{ form.topic }}
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Status</label>
                    {{ form.status }}
                    <small style="color: #7b7268; font-size: 0.75rem; display: block; margin-top: 4px;">Private or Public</small>
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Type</label>
                    {{ form.entry_type }}
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Parent Page</label>
                    {{ form.parent }}
                    <small style="color: #7b7268; font-size: 0.75rem; display: block; margin-top: 4px;">Create hierarchy</small>
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Order</label>
                    {{ form.order }}
                    <small style="color: #7b7268; font-size: 0.75rem; display: block; margin-top: 4px;">Lower numbers first</small>
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Source (URL)</label>
                    {{ form.source_url }}
                </div>

                <div>
                    <label style="display: block; font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 500;">Tags</label>
                    {{ form.tags }}
                    <small style="color: #7b7268; font-size: 0.75rem; display: block; margin-top: 4px;">Separate with commas</small>
                </div>

                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        {{ form.is_favorite }}
                        <span style="font-size: 0.85rem; color: #7b7268; font-weight: 500;">Mark as favorite</span>
                    </label>
                </div>
            </div>
            </div>

            <!-- Main Editor -->
            <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px 40px 20px; padding-top: 0; min-height: 100vh;">
                <!-- Title Field -->
            <div style="margin-bottom: 4px;">
                <input type="text"
                       name="{{ form.title.name }}"
                       value="{{ form.title.value|default:'' }}"
                       placeholder="Untitled"
                       style="width: 100%; border: none; font-size: 2.8rem; font-weight: 700; padding: 0; outline: none; color: #3f372f; background: transparent; font-family: inherit;"
                       id="{{ form.title.id_for_label }}">
            </div>

            <!-- Summary Field -->
            <div style="margin-bottom: 30px;">
                <input type="text"
                       name="{{ form.summary.name }}"
                       value="{{ form.summary.value|default:'' }}"
                       placeholder="Page description (optional)..."
                       style="width: 100%; border: none; font-size: 0.95rem; padding: 0; outline: none; color: #9B9B9B; background: transparent; font-family: inherit;"
                       id="{{ form.summary.id_for_label }}">
            </div>

            <!-- Hidden Fields -->
            <textarea name="{{ form.content.name }}"
                      id="{{ form.content.id_for_label }}"
                      style="display: none;">{{ form.content.value|default:'' }}</textarea>

            <!-- Editor Container -->
            <div id="editorjs" style="min-height: 700px; outline: none; background: white; border-radius: 8px; padding: 30px;">
                <div id="editor-loading" style="text-align: center; padding: 40px; color: #7b7268;">
                    <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                    <div>Loading editor...</div>
                </div>
            </div>

            </form>
            </div>
        </main>

        <!-- Right Sidebar - Page Structure -->
        <aside id="right-sidebar" style="width: 320px; position: fixed; right: 0; top: 100px; height: calc(100vh - 100px); background: #F9F8F6; border-left: 1px solid #D9CFC7; padding: 20px; overflow-y: auto; transition: transform 0.3s ease; transform: translateX(0); z-index: 90;">
            {% if object %}
            {% with entry=object %}
            <!-- Topic Info -->
            {% if entry.topic %}
            <div style="margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.1) 0%, rgba(217, 207, 199, 0.1) 100%); border-radius: 8px; border-left: 3px solid #C9B59C;">
                <div style="font-size: 0.85rem; color: #7b7268; margin-bottom: 6px; font-weight: 600;">Topic</div>
                <div style="font-weight: 600; color: #3f372f; font-size: 1.05rem;">{{ entry.topic.name }}</div>
            </div>
            {% endif %}

            <!-- Page Structure -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; color: #3f372f; margin: 0;">Page Structure</h3>
                    <button onclick="toggleRightSidebar()" style="background: #EFE9E3; border: 1px solid #D9CFC7; color: #7b7268; cursor: pointer; font-size: 0.85rem; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#D9CFC7';" onmouseout="this.style.background='#EFE9E3';" title="Hide/Show structure">
                        Hide Structure
                    </button>
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" id="page-search" placeholder="Find page..."
                           style="width: 100%; padding: 8px 10px; border: 1px solid #D9CFC7; border-radius: 6px; font-size: 0.85rem; color: #3f372f; background: white; transition: all 0.2s;"
                           onkeyup="filterPages(this.value)"
                           onfocus="this.style.borderColor='#C9B59C'; this.style.boxShadow='0 0 0 3px rgba(201, 181, 156, 0.1)';"
                           onblur="this.style.borderColor='#D9CFC7'; this.style.boxShadow='none';">
                </div>

                <div class="entry-tree-container" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                    {% if entry.parent %}
                        <div class="page-item" style="margin-bottom: 8px;">
                            <a href="{% url 'knowledge:entry_detail' entry.parent.slug %}"
                               class="gitbook-sidebar-item"
                               style="font-size: 0.85rem; opacity: 0.7; padding: 6px 8px;"
                               data-page-title="{{ entry.parent.title|lower }}">
                                {{ entry.parent.title|truncatewords:4 }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="page-item current-page" style="margin: 8px 0; padding: 10px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.15) 0%, rgba(217, 207, 199, 0.15) 100%); border-left: 3px solid #C9B59C; border-radius: 6px;">
                        <div style="font-weight: 600; color: #3f372f; font-size: 0.9rem;">
                            {{ entry.title }}{% if entry.is_favorite %} ★{% endif %}
                        </div>
                    </div>

                    {% if entry.children.all %}
                        <div class="children-section" style="margin-left: 12px; border-left: 2px solid #D9CFC7; padding-left: 8px;">
                            <div style="font-size: 0.8rem; color: #7b7268; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                                <span>Child Pages ({{ entry.children.all|length }})</span>
                                {% if entry.children.all|length > 5 %}
                                <button onclick="toggleAllChildren(this)" data-expanded="false"
                                        style="padding: 3px 6px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#D9CFC7';"
                                        onmouseout="this.style.background='#EFE9E3';">
                                    All
                                </button>
                                {% endif %}
                            </div>
                            <div class="children-list">
                                {% for child in entry.children.all %}
                                    <div class="tree-item {% if forloop.counter > 5 %}hidden-item{% endif %}" style="margin-bottom: 2px; {% if forloop.counter > 5 %}display: none;{% endif %}">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            {% if child.children.all %}
                                            <button class="tree-toggle" onclick="toggleTreeNode(this)" data-collapsed="true"
                                                    style="width: 14px; height: 14px; border: none; background: none; cursor: pointer; font-size: 9px; padding: 0; color: #7b7268; transition: transform 0.2s;">
                                                >
                                            </button>
                                            {% else %}
                                            <span style="width: 14px; display: inline-block;"></span>
                                            {% endif %}
                                            <a href="{% url 'knowledge:entry_detail' child.slug %}"
                                               class="page-item gitbook-sidebar-item"
                                               style="flex: 1; padding: 5px 6px; margin: 0; border-radius: 4px; font-size: 0.85rem;"
                                               data-page-title="{{ child.title|lower }}">
                                                {{ child.title|truncatewords:4 }}
                                                {% if child.is_favorite %} ★{% endif %}
                                                {% if child.children.all %}<span style="margin-left: 4px; font-size: 0.7rem; color: #7b7268;">({{ child.children.all|length }})</span>{% endif %}
                                            </a>
                                        </div>
                                        {% if child.children.all %}
                                        <div class="tree-children" style="display: none; margin-left: 18px; border-left: 2px solid #E5DDD5; padding-left: 5px; margin-top: 2px;">
                                            {% for grandchild in child.children.all %}
                                            <a href="{% url 'knowledge:entry_detail' grandchild.slug %}"
                                               class="page-item gitbook-sidebar-item"
                                               style="display: block; padding: 4px 6px; margin-bottom: 2px; border-radius: 4px; font-size: 0.8rem; opacity: 0.9;"
                                               data-page-title="{{ grandchild.title|lower }}">
                                                {{ grandchild.title|truncatewords:3 }}
                                                {% if grandchild.is_favorite %} ★{% endif %}
                                            </a>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if entry.children.all|length > 5 %}
                            <button onclick="showMoreChildren(this)"
                                    style="margin-top: 8px; padding: 5px 8px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; width: 100%;"
                                    onmouseover="this.style.background='#D9CFC7';"
                                    onmouseout="this.style.background='#EFE9E3';">
                                Show {{ entry.children.all|length|add:"-5" }} pages
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if sibling_pages %}
                        <div class="siblings-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #D9CFC7;">
                            <div style="font-size: 0.8rem; color: #7b7268; margin-bottom: 8px; font-weight: 600;">
                                {% if entry.parent %}Siblings{% else %}Same Topic{% endif %} ({{ sibling_pages|length }})
                            </div>
                            <div class="siblings-list">
                                {% for page in sibling_pages %}
                                    <a href="{% url 'knowledge:entry_detail' page.slug %}"
                                       class="page-item gitbook-sidebar-item {% if forloop.counter > 5 %}hidden-item{% endif %}"
                                       style="margin-bottom: 3px; opacity: 0.8; padding: 5px 6px; font-size: 0.85rem; {% if forloop.counter > 5 %}display: none;{% endif %}"
                                       data-page-title="{{ page.title|lower }}">
                                        {{ page.title|truncatewords:4 }}
                                        {% if page.is_favorite %} ★{% endif %}
                                    </a>
                                {% endfor %}
                            </div>
                            {% if sibling_pages|length > 5 %}
                            <button onclick="showMoreSiblings(this)"
                                    style="margin-top: 8px; padding: 5px 8px; background: #EFE9E3; border: 1px solid #D9CFC7; border-radius: 4px; color: #7b7268; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; width: 100%;"
                                    onmouseover="this.style.background='#D9CFC7';"
                                    onmouseout="this.style.background='#EFE9E3';">
                                Show {{ sibling_pages|length|add:"-5" }} pages
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
            {% endif %}
        </aside>

        <!-- Toggle Right Sidebar Button (when collapsed) -->
        <button id="show-right-sidebar" onclick="toggleRightSidebar()" style="position: fixed; right: 12px; top: 140px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border: none; border-radius: 999px; padding: 10px 14px; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: all 0.3s; z-index: 100; font-size: 0.85rem; font-weight: 600;" onmouseover="this.style.transform='translateY(-2px)';" onmouseout="this.style.transform='translateY(0)';">
            Structure
        </button>
    </div>
</div>

<script>
function toggleRightSidebar() {
    const sidebar = document.getElementById('right-sidebar');
    const button = document.getElementById('show-right-sidebar');

    const isHidden = sidebar.style.transform === 'translateX(100%)';

    if (isHidden) {
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.borderLeft = '1px solid #D9CFC7';
        button.textContent = 'Structure';
    } else {
        sidebar.style.transform = 'translateX(100%)';
        sidebar.style.borderLeft = 'none';
        button.textContent = 'Show Structure';
    }
}

function toggleSidebarEntry(button) {
    const item = button.closest('.sidebar-tree-item');
    const children = item.querySelector('.sidebar-tree-children');

    if (!children) return;

    const isCollapsed = button.dataset.collapsed === 'true';
    button.dataset.collapsed = !isCollapsed;
    button.classList.toggle('collapsed');
    children.classList.toggle('collapsed');
}

function filterSidebarPages(searchTerm) {
    const term = (searchTerm || '').toLowerCase().trim();
    const nodes = document.querySelectorAll('.entry-tree-container [data-page-title]');

    nodes.forEach((node) => {
        const title = node.getAttribute('data-page-title') || '';
        const item = node.closest('.sidebar-tree-item');
        if (!item) return;

        if (!term || title.includes(term)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function filterPages(searchTerm) {
    const term = (searchTerm || '').toLowerCase().trim();
    const items = document.querySelectorAll('.entry-tree-container [data-page-title]');

    items.forEach((item) => {
        const title = item.getAttribute('data-page-title') || '';
        if (!term || title.includes(term)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    const existingNoResults = document.querySelector('.entry-tree-container .no-results');
    if (existingNoResults) {
        existingNoResults.remove();
    }

    if (term) {
        const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
        if (visibleItems.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.style.cssText = 'padding: 10px; color: #7b7268; font-size: 0.85rem; text-align: center;';
            noResults.textContent = 'No pages found';
            document.querySelector('.entry-tree-container').appendChild(noResults);
        }
    }
}

function showMoreChildren(button) {
    const childrenList = button.parentElement.querySelector('.children-list');
    const hiddenItems = childrenList.querySelectorAll('.hidden-item');
    hiddenItems.forEach(item => {
        item.style.display = 'block';
        item.classList.remove('hidden-item');
    });
    button.style.display = 'none';
}

function showMoreSiblings(button) {
    const siblingsList = button.parentElement.querySelector('.siblings-list');
    const hiddenItems = siblingsList.querySelectorAll('.hidden-item');
    hiddenItems.forEach(item => {
        item.style.display = 'block';
        item.classList.remove('hidden-item');
    });
    button.style.display = 'none';
}

function toggleTreeNode(button) {
    const treeItem = button.closest('.tree-item');
    const childrenContainer = treeItem.querySelector('.tree-children');
    
    if (!childrenContainer) return;
    
    const isCollapsed = button.dataset.collapsed === 'true';
    button.dataset.collapsed = !isCollapsed;
    
    if (isCollapsed) {
        childrenContainer.style.display = 'block';
        button.textContent = 'v';
    } else {
        childrenContainer.style.display = 'none';
        button.textContent = '>';
    }
}

function toggleAllChildren(button) {
    const isExpanded = button.dataset.expanded === 'true';
    const childrenSection = button.closest('.children-section');
    const allToggles = childrenSection.querySelectorAll('.tree-toggle');
    
    allToggles.forEach(toggle => {
        const childrenContainer = toggle.closest('.tree-item').querySelector('.tree-children');
        if (childrenContainer) {
            if (isExpanded) {
                childrenContainer.style.display = 'none';
                toggle.textContent = '>';
                toggle.dataset.collapsed = 'true';
            } else {
                childrenContainer.style.display = 'block';
                toggle.textContent = 'v';
                toggle.dataset.collapsed = 'false';
            }
        }
    });
    
    button.dataset.expanded = !isExpanded;
    button.textContent = isExpanded ? 'Expand All' : 'Collapse All';
}

function toggleSettings() {
    const sidebar = document.getElementById('settings-sidebar');
    if (sidebar.style.right === '0px') {
        sidebar.style.right = '-350px';
    } else {
        sidebar.style.right = '0px';
    }
}

// Close settings when clicking outside
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('settings-sidebar');
    const settingsBtn = event.target.closest('button[onclick="toggleSettings()"]');
    const clickedInside = sidebar.contains(event.target) || settingsBtn;

    if (!clickedInside && sidebar.style.right === '0px') {
        sidebar.style.right = '-350px';
    }
});

// Debug: Check if Editor.js loaded
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    console.log('EditorJS available:', typeof EditorJS !== 'undefined');
    console.log('Header available:', typeof Header !== 'undefined');
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/slug-generator.js' %}"></script>

<!-- Editor.js Core -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.29.0/dist/editorjs.umd.min.js"></script>

<!-- Editor.js Plugins -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.1/dist/header.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.9.0/dist/list.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.6.0/dist/quote.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@2.9.0/dist/code.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@2.3.0/dist/table.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@1.6.0/dist/checklist.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@1.4.0/dist/delimiter.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.5.0/dist/inline-code.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@1.4.0/dist/marker.umd.min.js"></script>

<script>
// Wait for all scripts to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Starting Editor.js initialization ===');

    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    const initialMarkdown = contentTextarea.value || '';

    console.log('Content textarea found:', !!contentTextarea);
    console.log('Initial markdown:', initialMarkdown ? `${initialMarkdown.length} characters` : 'empty');

    // Wait for all Editor.js plugins to load
    function waitForPlugins(callback, maxAttempts = 50) {
        let attempts = 0;
        const checkPlugins = setInterval(function() {
            attempts++;
            console.log(`Checking plugins... attempt ${attempts}`);

            if (typeof EditorJS !== 'undefined' &&
                typeof Header !== 'undefined' &&
                typeof List !== 'undefined' &&
                typeof Quote !== 'undefined' &&
                typeof CodeTool !== 'undefined' &&
                typeof Checklist !== 'undefined' &&
                typeof Delimiter !== 'undefined' &&
                typeof InlineCode !== 'undefined' &&
                typeof Marker !== 'undefined' &&
                typeof Table !== 'undefined') {

                clearInterval(checkPlugins);
                console.log('✓ All plugins loaded successfully');
                callback();
            } else if (attempts >= maxAttempts) {
                clearInterval(checkPlugins);
                console.error('Timeout waiting for plugins to load');
                console.log('EditorJS:', typeof EditorJS);
                console.log('Header:', typeof Header);
                console.log('List:', typeof List);
                console.log('Quote:', typeof Quote);
                console.log('CodeTool:', typeof CodeTool);
                callback(); // Try anyway
            }
        }, 100);
    }

    // Initialize editor after plugins are loaded
    waitForPlugins(function() {

    // Convert Markdown to Editor.js blocks (simple conversion)
    function markdownToBlocks(markdown) {
        if (!markdown || markdown.trim() === '') {
            return [];
        }

        const lines = markdown.split('\n');
        const blocks = [];
        let currentParagraph = [];

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            // Headers
            if (line.startsWith('# ')) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                blocks.push({ type: 'header', data: { text: line.substring(2), level: 1 } });
            } else if (line.startsWith('## ')) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                blocks.push({ type: 'header', data: { text: line.substring(3), level: 2 } });
            } else if (line.startsWith('### ')) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                blocks.push({ type: 'header', data: { text: line.substring(4), level: 3 } });
            }
            // Code blocks
            else if (line.startsWith('```')) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                const codeLines = [];
                i++;
                while (i < lines.length && !lines[i].startsWith('```')) {
                    codeLines.push(lines[i]);
                    i++;
                }
                blocks.push({ type: 'code', data: { code: codeLines.join('\n') } });
            }
            // Lists
            else if (line.match(/^[\-\*] /)) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                const items = [line.substring(2)];
                while (i + 1 < lines.length && lines[i + 1].match(/^[\-\*] /)) {
                    i++;
                    items.push(lines[i].substring(2));
                }
                blocks.push({ type: 'list', data: { style: 'unordered', items: items } });
            }
            // Quote
            else if (line.startsWith('> ')) {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                blocks.push({ type: 'quote', data: { text: line.substring(2) } });
            }
            // Delimiter
            else if (line.trim() === '---') {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
                blocks.push({ type: 'delimiter', data: {} });
            }
            // Empty line - end paragraph
            else if (line.trim() === '') {
                if (currentParagraph.length > 0) {
                    blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
                    currentParagraph = [];
                }
            }
            // Regular paragraph text
            else {
                currentParagraph.push(line);
            }
        }

        // Add remaining paragraph
        if (currentParagraph.length > 0) {
            blocks.push({ type: 'paragraph', data: { text: currentParagraph.join('<br>') } });
        }

        return blocks;
    }

    // Convert Editor.js blocks to Markdown
    function blocksToMarkdown(blocks) {
        let markdown = '';

        blocks.forEach((block, index) => {
            switch (block.type) {
                case 'header':
                    const hashes = '#'.repeat(block.data.level);
                    markdown += `${hashes} ${block.data.text}\n\n`;
                    break;

                case 'paragraph':
                    markdown += `${block.data.text.replace(/<br>/g, '\n')}\n\n`;
                    break;

                case 'list':
                    block.data.items.forEach(item => {
                        const prefix = block.data.style === 'ordered' ? '1.' : '-';
                        markdown += `${prefix} ${item}\n`;
                    });
                    markdown += '\n';
                    break;

                case 'checklist':
                    block.data.items.forEach(item => {
                        const checkbox = item.checked ? '[x]' : '[ ]';
                        markdown += `- ${checkbox} ${item.text}\n`;
                    });
                    markdown += '\n';
                    break;

                case 'quote':
                    markdown += `> ${block.data.text}\n\n`;
                    break;

                case 'code':
                    markdown += `\`\`\`\n${block.data.code}\n\`\`\`\n\n`;
                    break;

                case 'delimiter':
                    markdown += `---\n\n`;
                    break;

                case 'table':
                    if (block.data.content && block.data.content.length > 0) {
                        // Header row
                        markdown += '| ' + block.data.content[0].join(' | ') + ' |\n';
                        markdown += '| ' + block.data.content[0].map(() => '---').join(' | ') + ' |\n';
                        // Data rows
                        for (let i = 1; i < block.data.content.length; i++) {
                            markdown += '| ' + block.data.content[i].join(' | ') + ' |\n';
                        }
                        markdown += '\n';
                    }
                    break;

                default:
                    // Fallback for unknown types
                    if (block.data.text) {
                        markdown += `${block.data.text}\n\n`;
                    }
            }
        });

        return markdown.trim();
    }

    // Initialize Editor.js with error handling
    let editor;

    try {
        console.log('Initializing Editor.js...');
        console.log('Initial markdown length:', initialMarkdown.length);

        // Check if all required libraries are loaded
        if (typeof EditorJS === 'undefined') {
            throw new Error('EditorJS library not loaded');
        }
        if (typeof Header === 'undefined') {
            throw new Error('Header plugin not loaded');
        }
        if (typeof List === 'undefined') {
            throw new Error('List plugin not loaded');
        }

        editor = new EditorJS({
            holder: 'editorjs',
            placeholder: 'Press Tab to start writing or type / to choose a block...',
            autofocus: true,

            tools: {
                header: {
                    class: Header,
                    config: {
                        placeholder: 'Heading',
                        levels: [1, 2, 3, 4],
                        defaultLevel: 2
                    }
                },
                list: {
                    class: List,
                    inlineToolbar: true,
                    config: {
                        defaultStyle: 'unordered'
                    }
                },
                checklist: {
                    class: Checklist,
                    inlineToolbar: true
                },
                quote: {
                    class: Quote,
                    inlineToolbar: true,
                    config: {
                        quotePlaceholder: 'Enter quote',
                        captionPlaceholder: 'Author'
                    }
                },
                code: {
                    class: CodeTool,
                    placeholder: 'Enter code'
                },
                delimiter: Delimiter,
                inlineCode: {
                    class: InlineCode,
                    shortcut: 'CMD+SHIFT+M'
                },
                marker: {
                    class: Marker,
                    shortcut: 'CMD+SHIFT+H'
                },
                table: {
                    class: Table,
                    inlineToolbar: true
                }
            },

            data: {
                blocks: markdownToBlocks(initialMarkdown)
            },

            onReady: () => {
                console.log('✓ Editor.js is ready');
                // Remove loading message
                const loadingMsg = document.getElementById('editor-loading');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
            },

            onChange: (api, event) => {
                console.log('Editor content changed');
            }
        });

        console.log('✓ Editor.js initialized successfully');

    } catch (error) {
        console.error('✗ Error initializing Editor.js:', error);

        // Show error in the editor container
        const editorContainer = document.getElementById('editorjs');
        editorContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #C9B59C;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div style="font-weight: 600; margin-bottom: 10px;">Unable to load editor</div>
                <div style="font-size: 0.9rem; color: #7b7268;">${error.message}</div>
                <div style="margin-top: 20px; font-size: 0.85rem; color: #7b7268;">
                    Please check your internet connection and reload the page
                </div>
            </div>
        `;
    }

    // Custom styling for Editor.js - Clean GitBook style
    const editorStyle = document.createElement('style');
    editorStyle.textContent = `
        /* Editor Container */
        .codex-editor__redactor {
            padding-bottom: 200px !important;
        }

        .ce-block__content {
            max-width: 100%;
        }

        .ce-toolbar__content {
            max-width: 100%;
        }

        /* Hide default toolbar - use inline tools only */
        .ce-toolbar__plus {
            color: #9B9B9B;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .ce-block:hover .ce-toolbar__plus {
            opacity: 1;
        }

        .ce-toolbar__settings-btn {
            color: #9B9B9B;
        }

        .ce-toolbar__plus:hover,
        .ce-toolbar__settings-btn:hover {
            background-color: transparent;
        }

        /* Block Styling */
        .ce-block {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 1rem;
            line-height: 1.7;
            color: #3f372f;
            padding: 3px 0;
        }

        .ce-block--focused {
            background: transparent;
        }

        /* Paragraph */
        .ce-paragraph {
            color: #3f372f;
            font-size: 1rem;
            line-height: 1.7;
        }

        .ce-paragraph[data-placeholder]:empty::before {
            color: #9B9B9B;
            font-weight: 400;
        }

        /* Headers */
        .ce-header {
            font-weight: 700;
            color: #3f372f;
            padding: 4px 0;
            margin: 0;
        }

        /* Lists */
        .cdx-list {
            color: #3f372f;
        }

        .cdx-list__item {
            padding: 3px 0;
            line-height: 1.7;
        }

        /* Checklist */
        .cdx-checklist__item {
            color: #3f372f;
        }

        /* Quote */
        .cdx-quote {
            border-left: 4px solid #D9CFC7;
            padding-left: 20px;
            color: #7b7268;
            font-style: italic;
            margin: 10px 0;
        }

        /* Code */
        .ce-code__textarea {
            background: #F9F8F6;
            color: #3f372f;
            border: 1px solid #EFE9E3;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 15px;
        }

        /* Inline Code */
        .inline-code {
            background-color: #F9F8F6;
            color: #C9B59C;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Marker (Highlight) */
        .cdx-marker {
            background-color: #FFF4CC;
            color: #3f372f;
        }

        /* Table */
        .tc-wrap {
            border: 1px solid #D9CFC7;
            border-radius: 4px;
            overflow: hidden;
        }

        .tc-table {
            border-collapse: collapse;
        }

        .tc-table__cell {
            border: 1px solid #D9CFC7;
            padding: 10px;
        }

        .tc-table__cell--selected {
            background-color: #F9F8F6;
        }

        /* Popover/Menu */
        .ce-popover {
            border: 1px solid #D9CFC7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .ce-popover__item {
            color: #3f372f;
            padding: 10px 14px;
        }

        .ce-popover__item:hover {
            background-color: #F9F8F6;
        }

        .ce-popover__item-icon {
            background-color: transparent;
            color: #7b7268;
        }

        /* Inline Toolbar */
        .ce-inline-toolbar {
            background: white;
            border: 1px solid #D9CFC7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .ce-inline-tool {
            color: #3f372f;
        }

        .ce-inline-tool:hover {
            background-color: #F9F8F6;
        }

        /* Conversion Toolbar */
        .ce-conversion-toolbar {
            background: white;
            border: 1px solid #D9CFC7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ce-conversion-tool:hover {
            background-color: #F9F8F6;
        }

        /* Delimiter */
        .ce-delimiter {
            line-height: 1.6em;
            width: 100%;
            text-align: center;
            color: #D9CFC7;
        }

        /* Remove default focus outline */
        .codex-editor--narrow .ce-toolbox {
            display: none;
        }
    `;
    document.head.appendChild(editorStyle);

    // Sync content to hidden textarea on form submission
    // IMPORTANT: Use specific selector to avoid finding logout form!
    const form = document.querySelector('form#entry-form');
    console.log('Form element found:', form);
    console.log('Form ID:', form ? form.id : 'null');
    console.log('Form action:', form ? form.action : 'null');

    if (!form) {
        console.error('CRITICAL: Form not found!');
        alert('Error: Form element not found!');
        return;
    }

    console.log('=== Editor.js initialization complete ===');

    // Handle form submit event - save editor content before submission
    form.addEventListener('submit', async function(e) {
        console.log('!!! FORM SUBMIT EVENT !!!');
        e.preventDefault(); // Prevent immediate submission

        // Validate title field
        const titleField = form.querySelector('input[name="{{ form.title.name }}"]');
        if (titleField && !titleField.value.trim()) {
            alert('Please enter a title for this page');
            titleField.focus();
            return;
        }

        if (!editor) {
            console.error('Editor not initialized');
            alert('Editor not initialized. Please reload the page.');
            return;
        }

        try {
            console.log('Saving editor content...');
            const outputData = await editor.save();
            console.log('Editor saved successfully');

            const markdown = blocksToMarkdown(outputData.blocks);
            console.log('Converted to markdown, length:', (markdown || '').length);

            // Set content to hidden textarea
            contentTextarea.value = markdown || '';
            console.log('Content saved to textarea');

            // Log form data
            const formData = new FormData(form);
            console.log('Form data:');
            console.log('- Title:', formData.get('title'));
            console.log('- Parent:', formData.get('parent'));
            console.log('- Topic:', formData.get('topic'));

            // Now submit the form for real
            console.log('Submitting form to server...');
            form.submit(); // This will do a real POST to Django
        } catch (error) {
            console.error('Error saving editor content:', error);
            alert('Error saving content: ' + error.message);
        }
    });

    console.log('Form submit handler attached successfully');
    }); // End of waitForPlugins callback
}); // End of DOMContentLoaded

// ===== Page Search and Pagination Functions =====

// Edit mode - filter pages
function filterEditPages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const pageItems = document.querySelectorAll('.form-page-item');
    const currentPage = document.querySelector('.current-edit-page');
    let visibleChildrenCount = 0;
    let visibleSiblingsCount = 0;

    pageItems.forEach(item => {
        const link = item.querySelector('a[data-page-title]') || item;
        const title = link.getAttribute('data-page-title') || '';

        if (term === '' || title.includes(term)) {
            item.style.display = '';
            if (item.closest('.edit-children-list')) {
                visibleChildrenCount++;
            } else if (item.closest('.edit-siblings-list')) {
                visibleSiblingsCount++;
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Update counts
    if (term !== '') {
        const childrenCount = document.querySelector('.edit-children-count');
        if (childrenCount) childrenCount.textContent = `(${visibleChildrenCount})`;

        const siblingsCount = document.querySelector('.edit-siblings-count');
        if (siblingsCount) siblingsCount.textContent = `(${visibleSiblingsCount})`;
    }

    // Hide show more buttons when filtering
    const buttons = document.querySelectorAll('.edit-children-section button, .edit-siblings-section button');
    buttons.forEach(btn => btn.style.display = term === '' ? '' : 'none');
}

function showMoreEditChildren(button) {
    const section = button.closest('.edit-children-section');
    const hiddenItems = section.querySelectorAll('.hidden-edit-item');
    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-edit-item');
    });
    button.style.display = 'none';
}

function showMoreEditSiblings(button) {
    const section = button.closest('.edit-siblings-section');
    const hiddenItems = section.querySelectorAll('.hidden-edit-item');
    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-edit-item');
    });
    button.style.display = 'none';
}

// Create mode with parent - filter pages
function filterCreatePages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const pageItems = document.querySelectorAll('.create-page-item');
    const parentPage = document.querySelector('.create-parent-page');
    const newPageIndicator = document.querySelector('.new-page-indicator');
    let visibleChildrenCount = 0;
    let visibleSiblingsCount = 0;

    pageItems.forEach(item => {
        const link = item.querySelector('a[data-page-title]') || item;
        const title = link.getAttribute('data-page-title') || '';

        if (term === '' || title.includes(term)) {
            item.style.display = '';
            if (item.closest('.create-children-list')) {
                visibleChildrenCount++;
            } else if (item.closest('.create-siblings-list')) {
                visibleSiblingsCount++;
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Update counts
    if (term !== '') {
        const childrenCount = document.querySelector('.create-children-count');
        if (childrenCount) childrenCount.textContent = `(${visibleChildrenCount})`;

        const siblingsCount = document.querySelector('.create-siblings-count');
        if (siblingsCount) siblingsCount.textContent = `(${visibleSiblingsCount})`;
    }

    // Hide show more buttons when filtering
    const buttons = document.querySelectorAll('.create-children-section button, .create-siblings-section button');
    buttons.forEach(btn => btn.style.display = term === '' ? '' : 'none');
}

function showMoreCreateChildren(button) {
    const section = button.closest('.create-children-section');
    const hiddenItems = section.querySelectorAll('.hidden-create-item');
    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-create-item');
    });
    button.style.display = 'none';
}

function showMoreCreateSiblings(button) {
    const section = button.closest('.create-siblings-section');
    const hiddenItems = section.querySelectorAll('.hidden-create-item');
    hiddenItems.forEach(item => {
        item.style.display = '';
        item.classList.remove('hidden-create-item');
    });
    button.style.display = 'none';
}

// Root page creation - filter tree
function filterRootPages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const treeItems = document.querySelectorAll('.sidebar-tree-item');
    const noResults = document.getElementById('root-no-results');
    let visibleCount = 0;

    treeItems.forEach(item => {
        const link = item.querySelector('.sidebar-tree-link');
        if (!link) return;

        const title = link.textContent.toLowerCase();

        if (term === '' || title.includes(term)) {
            item.style.display = '';
            visibleCount++;

            // If filtering, expand all matching items
            if (term !== '') {
                const children = item.querySelector('.sidebar-tree-children');
                const toggle = item.querySelector('.sidebar-tree-toggle');
                if (children && toggle) {
                    children.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    toggle.dataset.collapsed = 'false';
                }
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Show/hide no results message
    if (visibleCount === 0 && term !== '') {
        noResults.style.display = '';
    } else {
        noResults.style.display = 'none';
    }
}
</script>
{% endblock %}
