{% extends 'base.html' %}
{% load static %}

{% block title %}T√¨m ki·∫øm - Ki·∫øn Th·ª©c{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
{% endblock %}

{% block content %}
<div class="gitbook-container">
    <!-- Sidebar -->
    <aside class="gitbook-sidebar">
        <h3>üîó Ch·ªß ƒë·ªÅ</h3>
        <a href="{% url 'knowledge:search' %}?q={{ query }}" class="gitbook-sidebar-item {% if not selected_topic %}active{% endif %}">
            üìö T·∫•t c·∫£
        </a>
        {% if topics %}
            {% for topic in topics %}
            <a href="{% url 'knowledge:search' %}?q={{ query }}&topic={{ topic.id }}" 
               class="gitbook-sidebar-item {% if selected_topic == topic.id|stringformat:'s' %}active{% endif %}">
                üìå {{ topic.name }}
            </a>
            {% endfor %}
        {% endif %}

        <h3>üè∑Ô∏è Lo·∫°i</h3>
        <a href="{% url 'knowledge:search' %}?q={{ query }}" class="gitbook-sidebar-item {% if not selected_type %}active{% endif %}">T·∫•t c·∫£</a>
        <a href="{% url 'knowledge:search' %}?q={{ query }}&type=note" class="gitbook-sidebar-item {% if selected_type == 'note' %}active{% endif %}">Ghi ch√∫</a>
        <a href="{% url 'knowledge:search' %}?q={{ query }}&type=research" class="gitbook-sidebar-item {% if selected_type == 'research' %}active{% endif %}">Nghi√™n c·ª©u</a>
        <a href="{% url 'knowledge:search' %}?q={{ query }}&type=article" class="gitbook-sidebar-item {% if selected_type == 'article' %}active{% endif %}">B√†i vi·∫øt</a>
        <a href="{% url 'knowledge:search' %}?q={{ query }}&type=reference" class="gitbook-sidebar-item {% if selected_type == 'reference' %}active{% endif %}">Tham kh·∫£o</a>

        <h3>‚öôÔ∏è Qu·∫£n l√Ω</h3>
        <a href="{% url 'knowledge:entry_list' %}" class="gitbook-sidebar-item">‚Üê Danh s√°ch</a>
    </aside>

    <!-- Main Content -->
    <main class="gitbook-main">
        <!-- Search Header -->
        <div class="gitbook-header" style="margin-bottom: 30px;">
            <div>
                <h1 class="gitbook-title">T√¨m ki·∫øm</h1>
                <p style="color: #7b7268; margin: 10px 0 0 0;">T√¨m ki·∫øm trong kho ki·∫øn th·ª©c c·ªßa b·∫°n</p>
            </div>
        </div>

        <!-- Search Form -->
        <form method="get" style="margin-bottom: 40px;">
            <div style="display: flex; gap: 10px;">
                <input 
                    type="text" 
                    name="q" 
                    value="{{ query }}" 
                    placeholder="Nh·∫≠p t·ª´ kh√≥a..."
                    style="flex: 1; padding: 12px 16px; border: 2px solid #D9CFC7; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s;"
                    onfocus="this.style.borderColor='#C9B59C'"
                    onblur="this.style.borderColor='#D9CFC7'"
                />
                <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    üîç T√¨m
                </button>
            </div>
            {% if selected_topic %}
            <input type="hidden" name="topic" value="{{ selected_topic }}" />
            {% endif %}
            {% if selected_type %}
            <input type="hidden" name="type" value="{{ selected_type }}" />
            {% endif %}
        </form>

        <!-- Results Stats -->
        {% if query %}
        <div style="margin-bottom: 30px; padding: 15px; background: #F9F8F6; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: #3f372f; font-weight: 600;">T√¨m th·∫•y {{ result_count }} k·∫øt qu·∫£</span>
                <span style="color: #7b7268; font-size: 0.9rem;"> ({{ query_time|floatformat:3 }} gi√¢y)</span>
            </div>
            {% if results %}
            <a href="{% url 'knowledge:entry_list' %}" style="color: #C9B59C; text-decoration: none; font-size: 0.9rem;">X√≥a b·ªô l·ªçc ‚Üí</a>
            {% endif %}
        </div>

        <!-- Results -->
        {% if results %}
            <div style="display: grid; gap: 20px;">
                {% for result in results %}
                <div class="search-result-item">
                    <div class="search-result-title">
                        <a href="{% url 'knowledge:entry_detail' result.slug %}" style="color: #C9B59C; text-decoration: none;">
                            {{ result.title }}
                        </a>
                        {% if result.is_favorite %}<span style="font-size: 1.1rem;">‚≠ê</span>{% endif %}
                    </div>
                    
                    {% if result.summary %}
                    <p class="search-result-excerpt">{{ result.summary }}</p>
                    {% else %}
                        {% comment %}Extract first 150 chars from content{% endcomment %}
                        {% if result.content %}
                        <p class="search-result-excerpt">{{ result.content|truncatewords:30 }}</p>
                        {% endif %}
                    {% endif %}
                    
                    <div class="search-result-meta">
                        {% if result.topic %}
                        <span style="padding: 2px 8px; background: #EFE9E3; border-radius: 3px; margin-right: 10px;">
                            üìå {{ result.topic.name }}
                        </span>
                        {% endif %}
                        <span style="padding: 2px 8px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.1) 0%, rgba(217, 207, 199, 0.1) 100%); border-radius: 3px; margin-right: 10px;">
                            {{ result.get_entry_type_display }}
                        </span>
                        <span>üìÖ {{ result.updated_at|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif query %}
            <div style="text-align: center; padding: 60px 20px;">
                <p style="font-size: 1.2rem; color: #7b7268; margin-bottom: 20px;">üòï Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho "{{ query }}"</p>
                <p style="color: #7b7268; margin-bottom: 30px;">H√£y th·ª≠ c√°c t·ª´ kh√≥a kh√°c ho·∫∑c quay l·∫°i danh s√°ch.</p>
                <a href="{% url 'knowledge:entry_list' %}" style="padding: 12px 24px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                    ‚Üê Danh s√°ch ghi ch√∫
                </a>
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <p style="font-size: 1.2rem; color: #7b7268; margin-bottom: 20px;">üîç Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm</p>
                <p style="color: #7b7268; margin-bottom: 30px;">T√¨m ki·∫øm trong ti√™u ƒë·ªÅ, n·ªôi dung, t√≥m t·∫Øt v√† tags c·ªßa c√°c ghi ch√∫.</p>
            </div>
        {% endif %}
    </main>
</div>

<style>
    @media (max-width: 768px) {
        .gitbook-header {
            flex-direction: column;
            gap: 15px;
        }
        
        form {
            flex-direction: column;
        }
    }
</style>
{% endblock %}
