{% extends 'base.html' %}
{% load static %}

{% block title %}Search - Knowledge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gitbook-style.css' %}">
{% endblock %}

{% block content %}
<div class="gitbook-container">
    <!-- Sidebar with Page Hierarchy -->
    <aside class="gitbook-sidebar">
        <div style="margin-bottom: 20px;">
            <a href="{% url 'knowledge:entry_create' %}"
               style="display: block; padding: 10px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                New Page
            </a>
        </div>

        <h3>All Pages</h3>

        <!-- Search Box for Sidebar -->
        {% if all_entries %}
        <div style="margin-bottom: 15px;">
            <input type="text" id="sidebar-page-search" placeholder="Filter pages..."
                   style="width: 100%; padding: 8px 12px; border: 1px solid #D9CFC7; border-radius: 6px; font-size: 0.85rem; color: #3f372f; background: white; transition: all 0.2s;"
                   onkeyup="filterSidebarPages(this.value)"
                   onfocus="this.style.borderColor='#C9B59C'; this.style.boxShadow='0 0 0 3px rgba(201, 181, 156, 0.1)';"
                   onblur="this.style.borderColor='#D9CFC7'; this.style.boxShadow='none';">
        </div>

        <div class="entry-tree-container" id="sidebar-tree-container">
            {% for entry in all_entries %}
                {% include "knowledge/entry_tree_item_sidebar.html" with entry=entry %}
            {% endfor %}
            <div id="sidebar-no-results" style="display: none; padding: 15px; text-align: center; color: #7b7268; font-size: 0.85rem; background: #F9F8F6; border-radius: 6px; margin-top: 10px;">
                No pages found
            </div>
        </div>
        {% else %}
            <p style="color: #7b7268; font-size: 0.9rem; padding: 10px;">No pages yet</p>
        {% endif %}

        <h3>Management</h3>
        <a href="{% url 'knowledge:entry_list' %}" class="gitbook-sidebar-item">List</a>
        <a href="{% url 'knowledge:topic_list' %}" class="gitbook-sidebar-item">Topics</a>
        <a href="{% url 'knowledge:resource_list' %}" class="gitbook-sidebar-item">Resources</a>
    </aside>

    <!-- Main Content -->
    <main class="gitbook-main">
        <!-- Header -->
        <div class="gitbook-header" style="margin-bottom: 20px;">
            <div>
                <h1 class="gitbook-title" style="font-size: 2.2rem; margin: 0 0 10px 0;">Search</h1>
                <p style="color: #7b7268; margin: 0;">Search your knowledge base</p>
            </div>
        </div>

        <!-- Controls: Search Form & Filters -->
        <div style="background: #F9F8F6; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #D9CFC7;">
            <!-- Search Form -->
            <form method="get" style="margin-bottom: 15px;">
                <div style="display: flex; gap: 10px;">
                    <input
                        type="text"
                        name="q"
                        value="{{ query }}"
                        placeholder="Enter search keywords..."
                        style="flex: 1; padding: 12px 16px; border: 2px solid #D9CFC7; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s;"
                        onfocus="this.style.borderColor='#C9B59C'"
                        onblur="this.style.borderColor='#D9CFC7'"
                    />
                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; white-space: nowrap;">
                        Search
                    </button>
                </div>
                {% if selected_topic %}
                <input type="hidden" name="topic" value="{{ selected_topic }}" />
                {% endif %}
                {% if selected_type %}
                <input type="hidden" name="type" value="{{ selected_type }}" />
                {% endif %}
            </form>

            <!-- Filters -->
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <span style="color: #7b7268; font-weight: 600; font-size: 0.9rem;">Filters:</span>

                <!-- Topic Filter -->
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <a href="{% url 'knowledge:search' %}?q={{ query }}"
                       class="filter-chip {% if not selected_topic %}active{% endif %}">
                        All Topics
                    </a>
                    {% for topic in topics %}
                    <a href="{% url 'knowledge:search' %}?q={{ query }}&topic={{ topic.id }}{% if selected_type %}&type={{ selected_type }}{% endif %}"
                       class="filter-chip {% if selected_topic == topic.id|stringformat:'s' %}active{% endif %}">
                        {{ topic.name }}
                    </a>
                    {% endfor %}
                </div>

                <span style="color: #D9CFC7;">|</span>

                <!-- Type Filter -->
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <a href="{% url 'knowledge:search' %}?q={{ query }}{% if selected_topic %}&topic={{ selected_topic }}{% endif %}"
                       class="filter-chip {% if not selected_type %}active{% endif %}">
                        All Types
                    </a>
                    <a href="{% url 'knowledge:search' %}?q={{ query }}&type=note{% if selected_topic %}&topic={{ selected_topic }}{% endif %}"
                       class="filter-chip {% if selected_type == 'note' %}active{% endif %}">
                        Notes
                    </a>
                    <a href="{% url 'knowledge:search' %}?q={{ query }}&type=research{% if selected_topic %}&topic={{ selected_topic }}{% endif %}"
                       class="filter-chip {% if selected_type == 'research' %}active{% endif %}">
                        Research
                    </a>
                    <a href="{% url 'knowledge:search' %}?q={{ query }}&type=article{% if selected_topic %}&topic={{ selected_topic }}{% endif %}"
                       class="filter-chip {% if selected_type == 'article' %}active{% endif %}">
                        Articles
                    </a>
                    <a href="{% url 'knowledge:search' %}?q={{ query }}&type=reference{% if selected_topic %}&topic={{ selected_topic }}{% endif %}"
                       class="filter-chip {% if selected_type == 'reference' %}active{% endif %}">
                        References
                    </a>
                </div>
            </div>
        </div>

        <!-- Results Stats -->
        {% if query %}
        <div style="margin-bottom: 30px; padding: 15px; background: white; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #EFE9E3;">
            <div>
                <span style="color: #3f372f; font-weight: 600;">Found {{ result_count }} results</span>
                <span style="color: #7b7268; font-size: 0.9rem;"> in {{ query_time|floatformat:3 }} seconds</span>
            </div>
            {% if results %}
            <a href="{% url 'knowledge:search' %}" style="color: #C9B59C; text-decoration: none; font-size: 0.9rem; font-weight: 600;">Clear Search ‚Üí</a>
            {% endif %}
        </div>

        <!-- Results -->
        {% if results %}
            <div style="display: grid; gap: 20px;">
                {% for result in results %}
                <div class="search-result-item">
                    <div class="search-result-title">
                        <a href="{% url 'knowledge:entry_detail' result.slug %}" style="color: #C9B59C; text-decoration: none; font-weight: 600; font-size: 1.15rem;">
                            {{ result.title }}
                        </a>
                        {% if result.is_favorite %}<span style="font-size: 1.1rem; margin-left: 8px;">‚≠ê</span>{% endif %}
                    </div>

                    {% if result.summary %}
                    <p class="search-result-excerpt">{{ result.summary }}</p>
                    {% else %}
                        {% if result.content %}
                        <p class="search-result-excerpt">{{ result.content|truncatewords:30 }}</p>
                        {% endif %}
                    {% endif %}

                    <div class="search-result-meta">
                        {% if result.topic %}
                        <span style="padding: 4px 12px; background: #EFE9E3; border-radius: 12px; margin-right: 10px; font-size: 0.85rem;">
                            üìå {{ result.topic.name }}
                        </span>
                        {% endif %}
                        <span style="padding: 4px 12px; background: linear-gradient(135deg, rgba(201, 181, 156, 0.1) 0%, rgba(217, 207, 199, 0.1) 100%); border-radius: 12px; margin-right: 10px; font-size: 0.85rem;">
                            {{ result.get_entry_type_display }}
                        </span>
                        <span style="color: #7b7268; font-size: 0.85rem;">üìÖ {{ result.updated_at|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px; background: #F9F8F6; border-radius: 8px;">
                <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                <p style="font-size: 1.2rem; color: #3f372f; margin-bottom: 10px; font-weight: 600;">No results found</p>
                <p style="color: #7b7268; margin-bottom: 30px;">No results found for "{{ query }}". Try different keywords or clear filters.</p>
                <a href="{% url 'knowledge:search' %}" style="padding: 12px 24px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                    ‚Üê New Search
                </a>
            </div>
        {% endif %}
        {% else %}
            <div style="text-align: center; padding: 60px 20px; background: #F9F8F6; border-radius: 8px;">
                <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                <p style="font-size: 1.2rem; color: #3f372f; margin-bottom: 10px; font-weight: 600;">Start Searching</p>
                <p style="color: #7b7268; margin-bottom: 30px;">Enter keywords to search in titles, content, summaries and tags of entries.</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <a href="{% url 'knowledge:entry_list' %}" style="padding: 12px 24px; background: white; border: 2px solid #D9CFC7; color: #3f372f; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                        View List
                    </a>
                    <a href="{% url 'knowledge:entry_create' %}" style="padding: 12px 24px; background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%); color: white; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                        Create New Page
                    </a>
                </div>
            </div>
        {% endif %}
    </main>
</div>

<style>
    /* Filter Chips */
    .filter-chip {
        display: inline-block;
        padding: 6px 12px;
        background: white;
        color: #7b7268;
        border: 1px solid #D9CFC7;
        border-radius: 16px;
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .filter-chip:hover {
        background: #EFE9E3;
        border-color: #C9B59C;
        color: #3f372f;
    }

    .filter-chip.active {
        background: linear-gradient(135deg, #C9B59C 0%, #D9CFC7 100%);
        color: white;
        border-color: #C9B59C;
        font-weight: 600;
    }

    /* Entry Tree in Sidebar */
    .entry-tree-container {
        max-height: calc(100vh - 400px);
        overflow-y: auto;
        padding-right: 5px;
    }

    .entry-tree-container::-webkit-scrollbar {
        width: 6px;
    }

    .entry-tree-container::-webkit-scrollbar-track {
        background: #F9F8F6;
    }

    .entry-tree-container::-webkit-scrollbar-thumb {
        background: #D9CFC7;
        border-radius: 3px;
    }

    .entry-tree-container::-webkit-scrollbar-thumb:hover {
        background: #C9B59C;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .gitbook-container {
            flex-direction: column;
        }

        .gitbook-sidebar {
            width: 100%;
            max-height: 400px;
            position: relative;
            top: 0;
            border-right: none;
            border-bottom: 1px solid #D9CFC7;
        }

        .entry-tree-container {
            max-height: 300px;
        }
    }

    @media (max-width: 768px) {
        .gitbook-header {
            flex-direction: column;
            gap: 15px;
        }

        form > div {
            flex-direction: column;
        }

        .filter-chip {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
    }
</style>

<script>
// Filter sidebar pages based on search input
function filterSidebarPages(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const treeItems = document.querySelectorAll('.sidebar-tree-item');
    const noResults = document.getElementById('sidebar-no-results');
    let visibleCount = 0;

    treeItems.forEach(item => {
        const link = item.querySelector('.sidebar-tree-link');
        if (!link) return;

        const title = link.textContent.toLowerCase();

        if (term === '' || title.includes(term)) {
            item.style.display = '';
            visibleCount++;

            // If filtering, expand all matching items to show children
            if (term !== '') {
                const children = item.querySelector('.sidebar-tree-children');
                const toggle = item.querySelector('.sidebar-tree-toggle');
                if (children && toggle) {
                    children.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    toggle.dataset.collapsed = 'false';
                }
            }
        } else {
            item.style.display = 'none';
        }
    });

    // Show/hide no results message
    if (visibleCount === 0 && term !== '') {
        noResults.style.display = '';
    } else {
        noResults.style.display = 'none';
    }
}
</script>
{% endblock %}
